import media from '@ohos.multimedia.media';
import MusicApiService from './MusicApiService';
import { MusicItem, PlayState, PlayMode } from '../models/MusicModels';

export { PlayState, PlayMode };

interface PlayerState {
  currentSong: MusicItem | null;
  playState: PlayState;
  currentTime: number;
  duration: number;
  playlist: MusicItem[];
  currentIndex: number;
  playMode: PlayMode;
}

type StateListener = (state: PlayerState) => void;

class AudioPlayerService {
  private static instance: AudioPlayerService | null = null;
  private avPlayer: media.AVPlayer | null = null;
  private state: PlayerState = {
    currentSong: null,
    playState: PlayState.IDLE,
    currentTime: 0,
    duration: 0,
    playlist: [],
    currentIndex: -1,
    playMode: PlayMode.LOOP
  };
  private listeners: StateListener[] = [];
  private updateTimer: number = -1;
  private quality: number = 320;
  private isPlayingLock: boolean = false; // ğŸ”’ æ’­æ”¾é”ï¼Œé˜²æ­¢é‡å¤åˆ‡æ­Œ

  private constructor() {}

  static getInstance(): AudioPlayerService {
    if (!AudioPlayerService.instance) {
      AudioPlayerService.instance = new AudioPlayerService();
    }
    return AudioPlayerService.instance;
  }

  subscribe(listener: StateListener): () => void {
    this.listeners.push(listener);
    listener(this.state);
    
    // ğŸ”¥ è¿”å›å–æ¶ˆè®¢é˜…å‡½æ•°
    return () => {
      this.unsubscribe(listener);
    };
  }

  unsubscribe(listener: StateListener): void {
    const index = this.listeners.indexOf(listener);
    if (index > -1) {
      this.listeners.splice(index, 1);
      console.info('[AudioPlayer] ç§»é™¤ç›‘å¬å™¨,å‰©ä½™:', this.listeners.length);
    }
  }

  private notifyListeners(): void {
    console.info('ğŸ” [AudioPlayer-Debug] é€šçŸ¥ç›‘å¬å™¨ï¼Œç›‘å¬å™¨æ•°é‡:', this.listeners.length);
    console.info('ğŸ” [AudioPlayer-Debug] å½“å‰çŠ¶æ€ - æ­Œæ›²:', this.state.currentSong?.name || 'null');
    console.info('ğŸ” [AudioPlayer-Debug] å½“å‰çŠ¶æ€ - playState:', this.state.playState);
    console.info('ğŸ” [AudioPlayer-Debug] å½“å‰çŠ¶æ€ - currentIndex:', this.state.currentIndex);
    
    // ğŸ”¥ æ ¸å¿ƒä¿®å¤ï¼šç›´æ¥æ›´æ–° AppStorageï¼Œç¡®ä¿UIç»„ä»¶å“åº”çŠ¶æ€å˜åŒ–
    AppStorage.setOrCreate('currentSong', this.state.currentSong);
    AppStorage.setOrCreate('playState', this.state.playState);
    AppStorage.setOrCreate('currentTime', this.state.currentTime);
    AppStorage.setOrCreate('duration', this.state.duration);
    AppStorage.setOrCreate('playlist', this.state.playlist);
    AppStorage.setOrCreate('currentIndex', this.state.currentIndex);
    AppStorage.setOrCreate('playMode', this.state.playMode);
    
    console.info('âœ… [AudioPlayer-Debug] AppStorage å·²æ›´æ–°');
    
    this.listeners.forEach((listener, index) => {
      console.info(`ğŸ” [AudioPlayer-Debug] è°ƒç”¨ç›‘å¬å™¨ ${index + 1}`);
      listener(this.state);
    });
  }

  /**
   * ğŸ”¥ æ ¸å¿ƒä¿®å¤ï¼šæ’­æ”¾æ­Œæ›²ï¼ˆå¸¦æ’­æ”¾é”ä¿æŠ¤ï¼‰
   */
  async play(song: MusicItem, playlist: MusicItem[], index: number): Promise<void> {
    // ğŸ”’ æ£€æŸ¥æ’­æ”¾é”ï¼Œé˜²æ­¢é‡å¤åˆ‡æ­Œ
    if (this.isPlayingLock) {
      console.warn('[AudioPlayer] æ­£åœ¨åˆ‡æ­Œä¸­ï¼Œå¿½ç•¥é‡å¤è¯·æ±‚');
      return;
    }

    console.info('[AudioPlayer] å¼€å§‹æ’­æ”¾:', song.name);

    // ğŸ”’ ä¸Šé”
    this.isPlayingLock = true;

    try {
      this.state.playlist = playlist;
      this.state.currentIndex = index;
      this.state.currentSong = song;
      this.state.playState = PlayState.LOADING;
      this.notifyListeners();

      const url = await MusicApiService.getMusicUrl(song.source, song.id, this.quality);
      console.info('[AudioPlayer] è·å–éŸ³é¢‘URLæˆåŠŸ');

      await this.initPlayer(url);

      this.state.playState = PlayState.PLAYING;
      this.notifyListeners();

    } catch (err) {
      const error = err instanceof Error ? err : new Error(String(err));
      console.error('[AudioPlayer] æ’­æ”¾å¤±è´¥:', error.message);
      this.state.playState = PlayState.ERROR;
      this.notifyListeners();
      throw error;
    } finally {
      // ğŸ”“ è§£é”
      this.isPlayingLock = false;
    }
  }

  /**
   * ğŸ”¥ æ ¸å¿ƒä¿®å¤ï¼šåˆå§‹åŒ–æ’­æ”¾å™¨ï¼ˆç­‰å¾…çŠ¶æ€æœºå®Œæˆï¼‰
   */
  private async initPlayer(url: string): Promise<void> {
    // é‡Šæ”¾æ—§æ’­æ”¾å™¨
    if (this.avPlayer) {
      try {
        // ğŸ”¥ ä¼˜åŒ–ï¼šå…ˆç§»é™¤æ‰€æœ‰ç›‘å¬å™¨ï¼Œé¿å…æ—§å›è°ƒå¹²æ‰°
        this.avPlayer.off('stateChange');
        this.avPlayer.off('durationUpdate');
        this.avPlayer.off('timeUpdate');
        this.avPlayer.off('endOfStream');
        this.avPlayer.off('error');

        await this.avPlayer.release();
      } catch (error) {
        console.error('[AudioPlayer] é‡Šæ”¾æ—§æ’­æ”¾å™¨å¤±è´¥:', error);
      } finally {
        this.avPlayer = null;
      }
    }

    // åˆ›å»ºæ–°æ’­æ”¾å™¨
    this.avPlayer = await media.createAVPlayer();

    // ğŸ”¥ å…³é”®ï¼šä½¿ç”¨Promiseç­‰å¾…çŠ¶æ€å˜åŒ–
    return new Promise((resolve, reject) => {
      let isPrepared = false;

      // ç›‘å¬çŠ¶æ€å˜åŒ–
      this.avPlayer!.on('stateChange', async (state) => {
        console.info('[AudioPlayer] çŠ¶æ€å˜åŒ–:', state);

        try {
          switch (state) {
            case 'initialized':
              // çŠ¶æ€2ï¼šå·²åˆå§‹åŒ–ï¼Œè°ƒç”¨prepare
              console.info('[AudioPlayer] è°ƒç”¨ prepare()');
              await this.avPlayer!.prepare();
              break;

            case 'prepared':
              // çŠ¶æ€3ï¼šå‡†å¤‡å®Œæˆï¼Œå¯ä»¥æ’­æ”¾
              console.info('[AudioPlayer] è°ƒç”¨ play()');
              isPrepared = true;
              await this.avPlayer!.play();
              this.startUpdateTimer();
              resolve(); // âœ… æˆåŠŸ
              break;

            case 'playing':
              console.info('[AudioPlayer] æ­£åœ¨æ’­æ”¾');
              break;

            case 'error':
              if (!isPrepared) {
                reject(new Error('æ’­æ”¾å™¨è¿›å…¥é”™è¯¯çŠ¶æ€'));
              }
              break;
          }
        } catch (error) {
          console.error('[AudioPlayer] çŠ¶æ€å¤„ç†å¤±è´¥:', error);
          if (!isPrepared) {
            reject(error);
          }
        }
      });

      // ç›‘å¬æ—¶é•¿æ›´æ–°
      this.avPlayer!.on('durationUpdate', (duration) => {
        this.state.duration = duration / 1000;
        this.notifyListeners();
      });

      // ç›‘å¬æ—¶é—´æ›´æ–°
      this.avPlayer!.on('timeUpdate', (time) => {
        this.state.currentTime = time / 1000;
        this.notifyListeners();
      });

      // ç›‘å¬æ’­æ”¾å®Œæˆ
      this.avPlayer!.on('endOfStream', () => {
        console.info('[AudioPlayer] æ’­æ”¾å®Œæˆ');
        this.next();
      });

      // ç›‘å¬é”™è¯¯
      this.avPlayer!.on('error', (error) => {
        console.error('[AudioPlayer] é”™è¯¯:', error);
        this.state.playState = PlayState.ERROR;
        this.notifyListeners();
        if (!isPrepared) {
          reject(error);
        }
      });

      // è®¾ç½®URLï¼ˆè§¦å‘çŠ¶æ€æœºï¼šidle â†’ initializedï¼‰
      try {
        this.avPlayer!.url = url;
        console.info('[AudioPlayer] URLå·²è®¾ç½®ï¼Œç­‰å¾…åˆå§‹åŒ–');
      } catch (error) {
        reject(error);
      }

      // è¶…æ—¶ä¿æŠ¤ï¼ˆ10ç§’ï¼‰
      setTimeout(() => {
        if (!isPrepared) {
          reject(new Error('æ’­æ”¾å™¨åˆå§‹åŒ–è¶…æ—¶'));
        }
      }, 10000);
    });
  }

  /**
   * åˆ‡æ¢æ’­æ”¾/æš‚åœ
   */
  async togglePlay(): Promise<void> {
    if (!this.avPlayer) return;

    try {
      if (this.state.playState === PlayState.PLAYING) {
        await this.avPlayer.pause();
        this.state.playState = PlayState.PAUSED;
        this.stopUpdateTimer();
      } else if (this.state.playState === PlayState.PAUSED) {
        await this.avPlayer.play();
        this.state.playState = PlayState.PLAYING;
        this.startUpdateTimer();
      }
      this.notifyListeners();
    } catch (error) {
      console.error('[AudioPlayer] åˆ‡æ¢æ’­æ”¾çŠ¶æ€å¤±è´¥:', error);
    }
  }

  /**
   * ä¸Šä¸€æ›²ï¼ˆå¼‚æ­¥æ–¹æ³•ï¼Œç­‰å¾…åˆ‡æ­Œå®Œæˆï¼‰
   */
  async previous(): Promise<void> {
    if (this.state.currentIndex > 0) {
      const newIndex = this.state.currentIndex - 1;
      await this.play(this.state.playlist[newIndex], this.state.playlist, newIndex);
    } else {
      console.warn('[AudioPlayer] å·²ç»æ˜¯ç¬¬ä¸€é¦–æ­Œ');
    }
  }

  /**
   * ä¸‹ä¸€æ›²ï¼ˆå¼‚æ­¥æ–¹æ³•ï¼Œç­‰å¾…åˆ‡æ­Œå®Œæˆï¼‰
   */
  async next(): Promise<void> {
    if (this.state.currentIndex < this.state.playlist.length - 1) {
      const newIndex = this.state.currentIndex + 1;
      await this.play(this.state.playlist[newIndex], this.state.playlist, newIndex);
    } else {
      console.warn('[AudioPlayer] å·²ç»æ˜¯æœ€åä¸€é¦–æ­Œ');
    }
  }

  /**
   * è·³è½¬åˆ°æŒ‡å®šä½ç½®
   */
  async seek(time: number): Promise<void> {
    if (this.avPlayer) {
      try {
        await this.avPlayer.seek(time * 1000);
        this.state.currentTime = time;
        this.notifyListeners();
      } catch (error) {
        console.error('[AudioPlayer] Seekå¤±è´¥:', error);
      }
    }
  }

  /**
   * è®¾ç½®éŸ³è´¨
   */
  setQuality(quality: number): void {
    this.quality = quality;
  }

  /**
   * å¯åŠ¨æ›´æ–°å®šæ—¶å™¨
   */
  private startUpdateTimer(): void {
    this.stopUpdateTimer();
    this.updateTimer = setInterval(() => {
      if (this.avPlayer && this.state.playState === PlayState.PLAYING) {
        this.notifyListeners();
      }
    }, 500);
  }

  /**
   * åœæ­¢æ›´æ–°å®šæ—¶å™¨
   */
  private stopUpdateTimer(): void {
    if (this.updateTimer !== -1) {
      clearInterval(this.updateTimer);
      this.updateTimer = -1;
    }
  }

  /**
   * ğŸ”¥ ä¿®å¤ï¼šåº”ç”¨å…³é—­æ—¶é‡Šæ”¾èµ„æº
   */
  async release(): Promise<void> {
    console.info('[AudioPlayer] é‡Šæ”¾èµ„æº');

    this.stopUpdateTimer();

    if (this.avPlayer) {
      try {
        // å…ˆåœæ­¢æ’­æ”¾
        if (this.state.playState === PlayState.PLAYING ||
          this.state.playState === PlayState.PAUSED) {
          await this.avPlayer.stop();
        }

        // é‡ç½®çŠ¶æ€
        await this.avPlayer.reset();

        // é‡Šæ”¾èµ„æº
        await this.avPlayer.release();

        console.info('[AudioPlayer] æ’­æ”¾å™¨å·²é‡Šæ”¾');
      } catch (error) {
        console.error('[AudioPlayer] é‡Šæ”¾å¤±è´¥:', error);
      } finally {
        this.avPlayer = null;
      }
    }

    // é‡ç½®çŠ¶æ€
    this.state.playState = PlayState.IDLE;
    this.state.currentSong = null;
    this.state.currentTime = 0;
    this.state.duration = 0;
    this.notifyListeners();
  }

  /**
   * ğŸ”¥ æ–°å¢ï¼šé‡ç½®æ’­æ”¾å™¨ï¼ˆç”¨äºé‡æ–°æ’­æ”¾ï¼‰
   */
  async reset(): Promise<void> {
    console.info('[AudioPlayer] é‡ç½®æ’­æ”¾å™¨');
    await this.release();
  }
}

export default AudioPlayerService;
