/**
 * ðŸŽµ è¿·ä½ æ’­æ”¾å™¨ç»„ä»¶
 *
 * åŠŸèƒ½: åº•éƒ¨è¿·ä½ æ’­æ”¾å™¨
 * - æ˜¾ç¤ºå½“å‰æ’­æ”¾æ­Œæ›²ä¿¡æ¯
 * - æ˜¾ç¤ºå°é¢å›¾ç‰‡(å¸¦æ—‹è½¬åŠ¨ç”»)
 * - æ’­æ”¾/æš‚åœæŽ§åˆ¶
 * - ç‚¹å‡»è·³è½¬åˆ°å®Œæ•´æ’­æ”¾é¡µé¢
 *
 * @author wujinzhihai
 * @github https://github.com/wujinzhihai
 */

import { MusicItem } from '../models/MusicModels';
import MusicApiService from '../services/MusicApiService';
import AudioPlayerService, { PlayState } from '../services/AudioPlayerService';
import router from '@ohos.router';

@Component
export struct MiniPlayer {
  @Watch('onSongChange')
  @StorageLink('currentSong') currentSong: MusicItem | null = null;
  @Watch('onPlayStateChange')
  @StorageLink('playState') playState: PlayState = PlayState.IDLE;
  @State coverUrl: string = '';
  @State rotateAngle: number = 0;

  private rotationTimer: number = -1;

  async onSongChange() {
    if (this.currentSong?.picId && this.currentSong?.source) {
      try {
        this.coverUrl = await MusicApiService.getPicUrl(
          this.currentSong.source,
          this.currentSong.picId,
          200
        );
      } catch (error) {
        console.error('[MiniPlayer] èŽ·å–å°é¢å¤±è´¥:', error);
        this.coverUrl = '';
      }
    } else {
      this.coverUrl = '';
    }

    // åˆ‡æ­Œæ—¶ç»§ç»­ä¿æŒæ—‹è½¬ï¼ˆå¦‚æžœæ­£åœ¨æ’­æ”¾ï¼‰
    if (this.playState === PlayState.PLAYING) {
      this.startRotation();
    }
  }

  onPlayStateChange() {
    if (this.playState === PlayState.PLAYING) {
      this.startRotation();
    } else {
      this.stopRotation();
    }
  }

  startRotation() {
    if (this.rotationTimer !== -1) {
      return; // å·²åœ¨æ—‹è½¬
    }

    this.rotationTimer = setInterval(() => {
      this.rotateAngle += 2;
      if (this.rotateAngle >= 360) {
        this.rotateAngle -= 360;
      }
    }, 16);
  }

  stopRotation() {
    if (this.rotationTimer !== -1) {
      clearInterval(this.rotationTimer);
      this.rotationTimer = -1;
    }
  }

  togglePlay() {
    AudioPlayerService.getInstance().togglePlay();
  }

  openPlayerPage() {
    try {
      router.pushUrl({
        url: 'pages/PlayerPage'
      });
    } catch (error) {
      console.error('[MiniPlayer] è·¯ç”±è·³è½¬å¤±è´¥:', error);
    }
  }

  aboutToDisappear() {
    this.stopRotation();
  }

  build() {
    Row() {
      // å°é¢ - åœ†å½¢æŒç»­æ—‹è½¬
      if (this.currentSong && this.coverUrl) {
        Image(this.coverUrl)
          .width(50)
          .height(50)
          .borderRadius(25)
          .backgroundColor('#F0F0F0')
          .rotate({
            x: 0,
            y: 0,
            z: 1,
            angle: this.rotateAngle
          })
          .onClick(() => {
            if (this.currentSong) {
              this.openPlayerPage();
            }
          })
      } else {
        Column() {
          Text('ðŸŽµ')
            .fontSize(20)
            .opacity(0.5)
        }
        .width(50)
        .height(50)
        .borderRadius(25)
        .backgroundColor('#F0F0F0')
        .justifyContent(FlexAlign.Center)
        .rotate({
          x: 0,
          y: 0,
          z: 1,
          angle: this.rotateAngle
        })
        .onClick(() => {
          if (this.currentSong) {
            this.openPlayerPage();
          }
        })
      }

      // æ­Œæ›²ä¿¡æ¯
      Column() {
        Text(this.currentSong ? this.currentSong.name : 'æš‚æ— æ’­æ”¾')
          .fontSize(15)
          .fontWeight(FontWeight.Medium)
          .maxLines(1)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
          .width('100%')

        Text(this.currentSong ? this.currentSong.artist : 'ç‚¹å‡»æœç´¢æ­Œæ›²')
          .fontSize(12)
          .fontColor('#999999')
          .maxLines(1)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
          .margin({ top: 4 })
          .width('100%')
      }
      .layoutWeight(1)
      .margin({ left: 12, right: 12 })
      .alignItems(HorizontalAlign.Start)
      .onClick(() => {
        if (this.currentSong) {
          this.openPlayerPage();
        }
      })

      // æ’­æ”¾/æš‚åœæŒ‰é’®
      Button({ type: ButtonType.Circle }) {
        Text(this.playState === PlayState.PLAYING ? 'â¸' : 'â–¶')
          .fontSize(20)
          .fontColor('#FFFFFF')
      }
      .width(44)
      .height(44)
      .backgroundColor(this.currentSong ? '#FF6B6B' : '#CCCCCC')
      .onClick(() => {
        if (this.currentSong) {
          this.togglePlay();
        }
      })
    }
    .width('100%')
    .height(70)
    .padding({ left: 16, right: 16 })
    .backgroundColor('#FFFFFF')
    .shadow({
      radius: 12,
      color: '#1A000000',
      offsetY: -4
    })
    .border({
      width: { top: 1 },
      color: '#F0F0F0'
    })
  }
}
