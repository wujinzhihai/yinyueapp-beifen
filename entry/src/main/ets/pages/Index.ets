/**
 * ğŸ  é¦–é¡µ
 *
 * åŠŸèƒ½: åº”ç”¨ä¸»é¡µ
 * - é¦–é¡µæœç´¢æ¡†
 * - æ˜¾ç¤ºæ¨èæ­Œå•
 * - æœç´¢ç»“æœè¦†ç›–å±‚(æ— å¯¼èˆªæ )
 * - åº•éƒ¨è¿·ä½ æ’­æ”¾å™¨
 * - åº•éƒ¨å¯¼èˆªæ (é¦–é¡µ/æœ¬åœ°éŸ³ä¹/æˆ‘çš„)
 *
 * @author wujinzhihai
 * @github https://github.com/wujinzhihai
 */

import { MusicItem } from '../services/MusicApiService';
import AudioPlayerService, { PlayState } from '../services/AudioPlayerService';
import MusicApiService from '../services/MusicApiService';
import { LocalMusicService } from '../services/LocalMusicService';
import { MiniPlayer } from '../components/MiniPlayer';
import { PlaylistPage } from './PlaylistPage';
import { MinePage } from './MinePage';
import promptAction from '@ohos.promptAction';
import router from '@ohos.router';
import { LOCAL_PLAYLISTS, PlaylistItem } from '../constants/LocalData';
import { TimeUtil } from '../utils/TimeUtil';
import { ErrorHandler, ErrorCode, AppError } from '../utils/ErrorHandler';

// ğŸ”¥ å°é¢å›¾ç‰‡ç»„ä»¶
@Component
struct SongCoverImage {
  @Prop song: MusicItem;
  @State coverUrl: string = '';
  @State isLoading: boolean = true;

  async aboutToAppear() {
    if (this.song.picId && this.song.source) {
      try {
        const url = await MusicApiService.getPicUrl(this.song.source, this.song.picId, 200);
        this.coverUrl = url;
      } catch (error) {
        console.error('[SongCoverImage] åŠ è½½å°é¢å¤±è´¥');
      } finally {
        this.isLoading = false;
      }
    } else {
      this.isLoading = false;
    }
  }

  build() {
    if (this.coverUrl) {
      Image(this.coverUrl)
        .width('100%')
        .height('100%')
        .borderRadius(8)
        .objectFit(ImageFit.Cover)
    } else {
      Column() {
        Text('ğŸµ')
          .fontSize(24)
          .opacity(0.3)
      }
      .width('100%')
      .height('100%')
      .borderRadius(8)
      .backgroundColor('#F5F5F5')
      .justifyContent(FlexAlign.Center)
    }
  }
}

@Entry
@Component
struct Index {
  @State searchKeyword: string = '';
  @State searchResults: MusicItem[] = [];
  @State isSearching: boolean = false;
  @State showSearchResults: boolean = false; // æ˜¯å¦æ˜¾ç¤ºæœç´¢ç»“æœè¦†ç›–å±‚
  @State currentTabIndex: number = 0; // å½“å‰æ ‡ç­¾é¡µç´¢å¼•
  @StorageProp('currentSong') currentSong: MusicItem | null = null;
  @StorageProp('playState') playState: PlayState = PlayState.IDLE;
  @StorageProp('currentIndex') currentIndex: number = -1;
  @State bannerIndex: number = 0;
  private bannerController: SwiperController = new SwiperController();

  async aboutToAppear() {
    console.info('[Index] é¡µé¢åˆå§‹åŒ–å®Œæˆ');
    // åˆå§‹åŒ–æœ¬åœ°éŸ³ä¹åº“
    await LocalMusicService.scanLocalMusic();
  }

  async performSearch() {
    if (!this.searchKeyword.trim()) {
      promptAction.showToast({ message: 'è¯·è¾“å…¥æœç´¢å…³é”®è¯' });
      return;
    }

    // æ˜¾ç¤ºæœç´¢ç»“æœè¦†ç›–å±‚
    this.showSearchResults = true;
    this.isSearching = true;
    this.searchResults = [];

    try {
      // æœç´¢ç½‘ç»œéŸ³ä¹
      const results = await MusicApiService.searchMusic(this.searchKeyword, 'netease');
      this.searchResults = results;
      console.info('[Index] ç½‘ç»œæœç´¢ç»“æœ:', results.length);

      if (this.searchResults.length === 0) {
        promptAction.showToast({ message: 'æœªæ‰¾åˆ°ç›¸å…³æ­Œæ›²' });
      }
    } catch (error) {
      const context: Record<string, Object> = {
        'keyword': this.searchKeyword as Object,
        'source': 'network' as Object
      };
      const appError = ErrorHandler.createNetworkError('æœç´¢å¤±è´¥', context);
      ErrorHandler.handle(appError);
    } finally {
      this.isSearching = false;
    }
  }

  // ä»é¦–é¡µè§¦å‘æœç´¢
  async searchFromHome(keyword: string) {
    this.searchKeyword = keyword;
    await this.performSearch();
  }

  closeSearchResults() {
    this.showSearchResults = false;
  }

  async playSong(song: MusicItem, index: number) {
    console.info('[Index] ç‚¹å‡»æ’­æ”¾:', song.name);

    try {
      await AudioPlayerService.getInstance().play(song, this.searchResults, index);
      console.info('[Index] æ’­æ”¾æœåŠ¡è°ƒç”¨æˆåŠŸ');

      await router.pushUrl({
        url: 'pages/PlayerPage'
      });

    } catch (error) {
      const context: Record<string, Object> = {
        'songId': song.id as Object,
        'songName': song.name as Object
      };
      const appError = ErrorHandler.createAudioError('æ’­æ”¾å¤±è´¥', context);
      ErrorHandler.handle(appError);
    }
  }

  formatDuration(seconds: number): string {
    return TimeUtil.formatTime(seconds);
  }

  build() {
    Stack() {
      // ä¸»å†…å®¹åŒºåŸŸ - ä½¿ç”¨Tabså®ç°åº•éƒ¨å¯¼èˆª
      Column() {
        Tabs({ barPosition: BarPosition.End, index: $$this.currentTabIndex }) {
          // é¦–é¡µæ ‡ç­¾
          TabContent() {
            Column() {
              // é¦–é¡µæœç´¢æ¡†
              Row() {
                TextInput({ placeholder: 'æœç´¢ç½‘ç»œéŸ³ä¹', text: $$this.searchKeyword })
                  .layoutWeight(1)
                  .height(50)
                  .fontSize(16)
                  .backgroundColor('#F5F5F5')
                  .borderRadius(25)
                  .padding({ left: 20, right: 20 })

                Button({ type: ButtonType.Circle }) {
                  Text('ğŸ”')
                    .fontSize(20)
                }
                .width(50)
                .height(50)
                .backgroundColor('#FF6B6B')
                .margin({ left: 12 })
                .onClick(() => {
                  this.performSearch();
                })
              }
              .width('100%')
              .padding(16)
              .backgroundColor('#FFFFFF')

              // é¦–é¡µå†…å®¹åŒºåŸŸ
              Column() {
                // ğŸ¨ æ¨ªå¹…å›¾ç‰‡å±•ç¤ºåŒºåŸŸ
                Column() {
                  Row() {
                    Text('çƒ­é—¨æ¨è')
                      .fontSize(20)
                      .fontWeight(FontWeight.Bold)
                      .fontColor('#333333')
                  }
                  .width('100%')
                  .padding({ left: 16, top: 12, bottom: 12 })

                  Swiper(this.bannerController) {
                    Image($r('app.media.pexels_steve'))
                      .width('100%')
                      .height(160)
                      .borderRadius(12)
                      .objectFit(ImageFit.Cover)
                      .shadow({
                        radius: 12,
                        color: 'rgba(0, 0, 0, 0.15)',
                        offsetX: 0,
                        offsetY: 4
                      })

                    Image($r('app.media.pexels_pixabay'))
                      .width('100%')
                      .height(160)
                      .borderRadius(12)
                      .objectFit(ImageFit.Cover)
                      .shadow({
                        radius: 12,
                        color: 'rgba(0, 0, 0, 0.15)',
                        offsetX: 0,
                        offsetY: 4
                      })

                    Image($r('app.media.pexels_juanpphotoandvideo'))
                      .width('100%')
                      .height(160)
                      .borderRadius(12)
                      .objectFit(ImageFit.Cover)
                      .shadow({
                        radius: 12,
                        color: 'rgba(0, 0, 0, 0.15)',
                        offsetX: 0,
                        offsetY: 4
                      })

                    Image($r('app.media.pexels_cottonbro'))
                      .width('100%')
                      .height(160)
                      .borderRadius(12)
                      .objectFit(ImageFit.Cover)
                      .shadow({
                        radius: 12,
                        color: 'rgba(0, 0, 0, 0.15)',
                        offsetX: 0,
                        offsetY: 4
                      })
                  }
                  .width('90%')
                  .height(180)
                  .autoPlay(true)
                  .interval(5000)
                  .loop(true)
                  .indicator(true)
                  .indicatorStyle({
                    bottom: 10,
                    color: Color.White,
                    selectedColor: '#FF6B6B'
                  })
                  .curve(Curve.Linear)
                  .onChange((index: number) => {
                    this.bannerIndex = index;
                  })
                }
                .width('100%')
                .backgroundColor('#FAFAFA')
                .padding({ bottom: 8 })

                // ç²¾é€‰æ¨èæ­Œå•
                Column() {
                  Row() {
                    Text('ç²¾é€‰æ¨è')
                      .fontSize(20)
                      .fontWeight(FontWeight.Bold)
                      .fontColor('#333333')
                  }
                  .width('100%')
                  .padding({ left: 16, top: 12, bottom: 12 })

                  List({ space: 12 }) {
                    ForEach(LOCAL_PLAYLISTS, (playlist: PlaylistItem) => {
                      ListItem() {
                        Column() {
                          Image($r(`app.media.${playlist.cover}`))
                            .width(140)
                            .height(140)
                            .borderRadius(12)
                            .objectFit(ImageFit.Cover)
                            .shadow({
                              radius: 8,
                              color: 'rgba(0, 0, 0, 0.1)',
                              offsetX: 0,
                              offsetY: 2
                            })

                          Text(playlist.name)
                            .fontSize(15)
                            .fontWeight(FontWeight.Medium)
                            .fontColor('#333333')
                            .maxLines(1)
                            .textOverflow({ overflow: TextOverflow.Ellipsis })
                            .margin({ top: 8 })
                            .width(140)

                          Text(playlist.description)
                            .fontSize(12)
                            .fontColor('#999999')
                            .maxLines(2)
                            .textOverflow({ overflow: TextOverflow.Ellipsis })
                            .margin({ top: 4 })
                            .width(140)
                        }
                        .alignItems(HorizontalAlign.Start)
                        .onClick(() => {
                          // è·³è½¬åˆ°æ­Œå•è¯¦æƒ…é¡µ
                          router.pushUrl({
                            url: 'pages/PlaylistDetailPage',
                            params: {
                              name: playlist.name,
                              description: playlist.description,
                              cover: playlist.cover,
                              keywords: playlist.keywords,
                              songs: playlist.songs
                            }
                          });
                        })
                      }
                    }, (playlist: PlaylistItem) => playlist.id)
                  }
                  .width('100%')
                  .height(230)
                  .listDirection(Axis.Horizontal)
                  .scrollBar(BarState.Off)
                  .padding({ left: 16, right: 16 })
                }
                .width('100%')
                .backgroundColor('#FAFAFA')
                .padding({ bottom: 20 })
              }
              .width('100%')
              .layoutWeight(1)

              // è¿·ä½ æ’­æ”¾å™¨
              MiniPlayer()
            }
            .width('100%')
            .height('100%')
          }
          .tabBar(this.TabBuilder('é¦–é¡µ', 0, 'ğŸ '))

          // æœ¬åœ°éŸ³ä¹æ ‡ç­¾
          TabContent() {
            PlaylistPage()
          }
          .tabBar(this.TabBuilder('æœ¬åœ°éŸ³ä¹', 1, 'ğŸ“€'))

          // æˆ‘çš„æ ‡ç­¾
          TabContent() {
            MinePage()
          }
          .tabBar(this.TabBuilder('æˆ‘çš„', 2, 'ğŸ‘¤'))
        }
        .width('100%')
        .height('100%')
        .barMode(BarMode.Fixed)
        .animationDuration(0)
        .onChange((index: number) => {
          this.currentTabIndex = index;
        })
      }
      .width('100%')
      .height('100%')

      // æœç´¢ç»“æœè¦†ç›–å±‚ (æ— å¯¼èˆªæ )
      if (this.showSearchResults) {
        Column() {
          // æœç´¢æ¡† (å¸¦è¿”å›æŒ‰é’®)
          Row() {
            Button({ type: ButtonType.Circle }) {
              Text('â†')
                .fontSize(24)
                .fontColor('#333333')
            }
            .width(50)
            .height(50)
            .backgroundColor('#F5F5F5')
            .onClick(() => {
              this.closeSearchResults();
            })

            TextInput({ placeholder: 'æœç´¢ç½‘ç»œéŸ³ä¹', text: $$this.searchKeyword })
              .layoutWeight(1)
              .height(50)
              .fontSize(16)
              .backgroundColor('#F5F5F5')
              .borderRadius(25)
              .padding({ left: 20, right: 20 })
              .margin({ left: 12 })

            Button({ type: ButtonType.Circle }) {
              Text('ğŸ”')
                .fontSize(20)
            }
            .width(50)
            .height(50)
            .backgroundColor('#FF6B6B')
            .margin({ left: 12 })
            .onClick(() => {
              this.performSearch();
            })
          }
          .width('100%')
          .padding(16)
          .backgroundColor('#FFFFFF')

          // æœç´¢ç»“æœå†…å®¹
          Column() {
            // åŠ è½½çŠ¶æ€
            if (this.isSearching) {
              Column() {
                LoadingProgress()
                  .width(40)
                  .height(40)
                  .color('#FF6B6B')
                Text('æœç´¢ä¸­...')
                  .fontSize(14)
                  .fontColor('#999999')
                  .margin({ top: 12 })
              }
              .width('100%')
              .layoutWeight(1)
              .justifyContent(FlexAlign.Center)
            } else if (this.searchResults.length > 0) {
              // æœç´¢ç»“æœåˆ—è¡¨
              Column() {
                Text(`å…±æ‰¾åˆ° ${this.searchResults.length} é¦–æ­Œæ›²`)
                  .fontSize(14)
                  .fontColor('#999999')
                  .width('100%')
                  .padding({ left: 16, right: 16, bottom: 12 })

                List({ space: 0 }) {
                  ForEach(this.searchResults, (item: MusicItem, index: number) => {
                    ListItem() {
                      Row() {
                        // å°é¢å›¾ç‰‡
                        SongCoverImage({ song: item })
                          .width(60)
                          .height(60)
                          .margin({ right: 12 })
  
                        // æ’­æ”¾çŠ¶æ€å›¾æ ‡
                        if (this.currentSong && this.currentSong.id === item.id && this.playState === PlayState.PLAYING) {
                          Text('â™«')
                            .fontSize(20)
                            .fontColor('#FF6B6B')
                            .fontWeight(FontWeight.Bold)
                            .margin({ right: 12 })
                        }
  
                        Column() {
                          Text(item.name)
                            .fontSize(16)
                            .fontWeight(FontWeight.Medium)
                            .maxLines(1)
                            .textOverflow({ overflow: TextOverflow.Ellipsis })
                            .width('100%')

                          Text(`${item.artist} - ${item.album || 'æœªçŸ¥ä¸“è¾‘'}`)
                            .fontSize(12)
                            .fontColor('#999999')
                            .maxLines(1)
                            .textOverflow({ overflow: TextOverflow.Ellipsis })
                            .margin({ top: 4 })
                            .width('100%')
                        }
                        .layoutWeight(1)
                        .margin({ left: 12, right: 12 })
                        .alignItems(HorizontalAlign.Start)

                        if (item.duration) {
                          Text(this.formatDuration(item.duration))
                            .fontSize(12)
                            .fontColor('#999999')
                        }
                      }
                      .width('100%')
                      .height(80)
                      .padding({ left: 16, right: 16 })
                      .backgroundColor(this.currentSong && this.currentSong.id === item.id ? '#FFF5F5' : '#FFFFFF')
                      .onClick(() => {
                        this.playSong(item, index);
                      })
                    }
                  }, (item: MusicItem) => item.id + item.source)
                }
                .width('100%')
                .layoutWeight(1)
                .divider({ strokeWidth: 1, color: '#F0F0F0' })
              }
              .width('100%')
              .layoutWeight(1)
            } else {
              // ç©ºçŠ¶æ€
              Column() {
                Text('ğŸ”')
                  .fontSize(80)
                  .opacity(0.3)
                Text('æš‚æ— æœç´¢ç»“æœ')
                  .fontSize(16)
                  .fontColor('#666666')
                  .margin({ top: 16 })
                Text('å°è¯•å…¶ä»–å…³é”®è¯')
                  .fontSize(12)
                  .fontColor('#999999')
                  .margin({ top: 8 })
              }
              .width('100%')
              .layoutWeight(1)
              .justifyContent(FlexAlign.Center)
            }
          }
          .width('100%')
          .layoutWeight(1)

          // è¿·ä½ æ’­æ”¾å™¨
          MiniPlayer()
        }
        .width('100%')
        .height('100%')
        .backgroundColor('#FFFFFF')
        .zIndex(999)
      }
    }
    .width('100%')
    .height('100%')
  }

  @Builder
  TabBuilder(title: string, index: number, icon: string) {
    Column() {
      Text(icon)
        .fontSize(24)
        .fontColor(this.currentTabIndex === index ? '#FF6B6B' : '#999999')

      Text(title)
        .fontSize(12)
        .fontColor(this.currentTabIndex === index ? '#FF6B6B' : '#999999')
        .margin({ top: 4 })
    }
    .width('100%')
    .height(60)
    .justifyContent(FlexAlign.Center)
  }
}
