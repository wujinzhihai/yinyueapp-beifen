import { MusicItem } from '../services/MusicApiService';
import AudioPlayerService, { PlayState } from '../services/AudioPlayerService';
import MusicApiService from '../services/MusicApiService';
import { MiniPlayer } from '../components/MiniPlayer';
import promptAction from '@ohos.promptAction';
import router from '@ohos.router';
import { LOCAL_PLAYLISTS, PlaylistItem } from '../constants/LocalData';
import { TimeUtil } from '../utils/TimeUtil';
import { Debounce } from '../utils/Debounce';
import { ErrorHandler, ErrorCode, AppError } from '../utils/ErrorHandler';

// ğŸ”¥ å°é¢å›¾ç‰‡ç»„ä»¶
@Component
struct SongCoverImage {
  @Prop song: MusicItem;
  @State coverUrl: string = '';
  @State isLoading: boolean = true;

  async aboutToAppear() {
    if (this.song.picId && this.song.source) {
      try {
        const url = await MusicApiService.getPicUrl(this.song.source, this.song.picId, 200);
        this.coverUrl = url;
      } catch (error) {
        console.error('[SongCoverImage] åŠ è½½å°é¢å¤±è´¥');
      } finally {
        this.isLoading = false;
      }
    } else {
      this.isLoading = false;
    }
  }

  build() {
    if (this.coverUrl) {
      Image(this.coverUrl)
        .width('100%')
        .height('100%')
        .borderRadius(8)
        .objectFit(ImageFit.Cover)
    } else {
      Column() {
        Text('ğŸµ')
          .fontSize(24)
          .opacity(0.3)
      }
      .width('100%')
      .height('100%')
      .borderRadius(8)
      .backgroundColor('#F5F5F5')
      .justifyContent(FlexAlign.Center)
    }
  }
}

@Entry
@Component
struct Index {
  @State searchKeyword: string = '';
  @State searchResults: MusicItem[] = [];
  @State isSearching: boolean = false;
  @StorageProp('currentSong') currentSong: MusicItem | null = null;
  @StorageProp('playState') playState: PlayState = PlayState.IDLE;
  @StorageProp('currentIndex') currentIndex: number = -1;

  aboutToAppear() {
    // ğŸ”¥ AudioPlayerService ç°åœ¨ç›´æ¥æ›´æ–° AppStorage,æ— éœ€æ‰‹åŠ¨è®¢é˜…
    console.info('[Index] é¡µé¢åˆå§‹åŒ–å®Œæˆ');
  }

  async performSearch() {
    if (!this.searchKeyword.trim()) {
      promptAction.showToast({ message: 'è¯·è¾“å…¥æœç´¢å…³é”®è¯' });
      return;
    }

    this.isSearching = true;
    this.searchResults = [];

    try {
      const results = await MusicApiService.searchMusic(this.searchKeyword, 'netease');
      this.searchResults = results;
      console.info('[Index] æœç´¢ç»“æœ:', results.length);

      if (results.length === 0) {
        promptAction.showToast({ message: 'æœªæ‰¾åˆ°ç›¸å…³æ­Œæ›²' });
      }
    } catch (error) {
      const context: Record<string, Object> = {
        'keyword': this.searchKeyword as Object
      };
      const appError = ErrorHandler.createNetworkError('æœç´¢å¤±è´¥', context);
      ErrorHandler.handle(appError);
    } finally {
      this.isSearching = false;
    }
  }

  async playSong(song: MusicItem, index: number) {
    console.info('[Index] ç‚¹å‡»æ’­æ”¾:', song.name);

    try {
      // ğŸ”¥ ä¿®å¤ï¼šä½¿ç”¨å®ä¾‹æ–¹æ³•
      await AudioPlayerService.getInstance().play(song, this.searchResults, index);
      console.info('[Index] æ’­æ”¾æœåŠ¡è°ƒç”¨æˆåŠŸ');

      await router.pushUrl({
        url: 'pages/PlayerPage'
      });

    } catch (error) {
      const context: Record<string, Object> = {
        'songId': song.id as Object,
        'songName': song.name as Object
      };
      const appError = ErrorHandler.createAudioError('æ’­æ”¾å¤±è´¥', context);
      ErrorHandler.handle(appError);
    }
  }

  formatDuration(seconds: number): string {
    return TimeUtil.formatTime(seconds);
  }

  build() {
    Column() {
      // æœç´¢æ 
      // æœç´¢æ 
      Row() {
        // ğŸ  è¿”å›é¦–é¡µæŒ‰é’®ï¼ˆä»…åœ¨æœç´¢ç»“æœé¡µæ˜¾ç¤ºï¼‰
        if (this.searchResults.length > 0) {
          Button({ type: ButtonType.Circle }) {
            Text('ğŸ ')
              .fontSize(20)
          }
          .width(50)
          .height(50)
          .backgroundColor('#F5F5F5')
          .margin({ right: 12 })
          .onClick(() => {
            // æ¸…ç©ºæœç´¢å…³é”®è¯å’Œç»“æœï¼Œå›åˆ°é¦–é¡µæ­Œå•åˆ—è¡¨
            this.searchKeyword = '';
            this.searchResults = [];
          })
        }

        TextInput({ placeholder: 'æœç´¢æ­Œæ›²ã€æ­Œæ‰‹', text: $$this.searchKeyword })
          .layoutWeight(1)
          .height(50)
          .fontSize(16)
          .backgroundColor('#F5F5F5')
          .borderRadius(25)
          .padding({ left: 20, right: 20 })
          .onChange((value: string) => {
            // ğŸ”¥ ä½¿ç”¨é˜²æŠ–ä¼˜åŒ–æœç´¢,é¿å…é¢‘ç¹è§¦å‘APIè¯·æ±‚
            Debounce.execute('search', () => {
              if (value.trim().length > 0) {
                this.performSearch();
              }
            }, 500);
          })
          .onSubmit(() => {
            // å›è½¦ç›´æ¥æœç´¢,å–æ¶ˆé˜²æŠ–
            Debounce.cancel('search');
            this.performSearch();
          })

        Button({ type: ButtonType.Circle }) {
          Text('ğŸ”')
            .fontSize(20)
        }
        .width(50)
        .height(50)
        .backgroundColor('#FF6B6B')
        .margin({ left: 12 })
        .onClick(() => {
          this.performSearch();
        })
      }
      .width('100%')
      .padding(16)
      .backgroundColor('#FFFFFF')

      // æ¨èæ­Œå•æ¨ªå‘æ»šåŠ¨
      if (this.searchResults.length === 0 && !this.isSearching) {
        Column() {
          // æ ‡é¢˜
          Row() {
            Text('ç²¾é€‰æ¨è')
              .fontSize(20)
              .fontWeight(FontWeight.Bold)
              .fontColor('#333333')
          }
          .width('100%')
          .padding({ left: 16, top: 12, bottom: 12 })

          // æ¨ªå‘æ»šåŠ¨æ­Œå•
          List({ space: 12 }) {
            ForEach(LOCAL_PLAYLISTS, (playlist: PlaylistItem) => {
              ListItem() {
                Column() {
                  // å°é¢
                  Image(playlist.cover)
                    .width(140)
                    .height(140)
                    .borderRadius(12)
                    .objectFit(ImageFit.Cover)
                    .shadow({
                      radius: 8,
                      color: 'rgba(0, 0, 0, 0.1)',
                      offsetX: 0,
                      offsetY: 2
                    })

                  // æ­Œå•åç§°
                  Text(playlist.name)
                    .fontSize(15)
                    .fontWeight(FontWeight.Medium)
                    .fontColor('#333333')
                    .maxLines(1)
                    .textOverflow({ overflow: TextOverflow.Ellipsis })
                    .margin({ top: 8 })
                    .width(140)

                  // æè¿°
                  Text(playlist.description)
                    .fontSize(12)
                    .fontColor('#999999')
                    .maxLines(2)
                    .textOverflow({ overflow: TextOverflow.Ellipsis })
                    .margin({ top: 4 })
                    .width(140)
                }
                .alignItems(HorizontalAlign.Start)
                .onClick(() => {
                  // ç‚¹å‡»æ­Œå•ï¼Œä½¿ç”¨ç¬¬ä¸€ä¸ªå…³é”®è¯æœç´¢
                  this.searchKeyword = playlist.keywords[0];
                  this.performSearch();
                })
              }
            }, (playlist: PlaylistItem) => playlist.id)
          }
          .width('100%')
          .height(230)
          .listDirection(Axis.Horizontal)
          .scrollBar(BarState.Off)
          .padding({ left: 16, right: 16 })
        }
        .width('100%')
        .backgroundColor('#FAFAFA')
        .padding({ bottom: 16 })
      }

      // åŠ è½½çŠ¶æ€
      if (this.isSearching) {
        Column() {
          LoadingProgress()
            .width(40)
            .height(40)
            .color('#FF6B6B')
          Text('æœç´¢ä¸­...')
            .fontSize(14)
            .fontColor('#999999')
            .margin({ top: 12 })
        }
        .width('100%')
        .height('100%')
        .justifyContent(FlexAlign.Center)
      } else if (this.searchResults.length > 0) {
        // æœç´¢ç»“æœåˆ—è¡¨
        List({ space: 0 }) {
          ForEach(this.searchResults, (item: MusicItem, index: number) => {
            ListItem() {
              Row() {
                // ğŸ”¥ æ·»åŠ å°é¢å›¾ç‰‡
                SongCoverImage({ song: item })
                  .width(60)
                  .height(60)
                  .margin({ right: 12 })

                Row() {
                  if (this.currentSong && this.currentSong.id === item.id && this.playState === PlayState.PLAYING) {
                    Text('â™«')
                      .fontSize(16)
                      .fontColor('#FF6B6B')
                      .fontWeight(FontWeight.Bold)
                      .margin({ right: 8 })
                  }
                  Text(`${index + 1}`)
                    .fontSize(14)
                    .fontColor('#999999')
                }
                .width(40)

                Column() {
                  Text(item.name)
                    .fontSize(16)
                    .fontWeight(FontWeight.Medium)
                    .maxLines(1)
                    .textOverflow({ overflow: TextOverflow.Ellipsis })
                    .width('100%')

                  Text(`${item.artist} - ${item.album || 'æœªçŸ¥ä¸“è¾‘'}`)
                    .fontSize(12)
                    .fontColor('#999999')
                    .maxLines(1)
                    .textOverflow({ overflow: TextOverflow.Ellipsis })
                    .margin({ top: 4 })
                    .width('100%')
                }
                .layoutWeight(1)
                .margin({ left: 12, right: 12 })
                .alignItems(HorizontalAlign.Start)

                if (item.duration) {
                  Text(this.formatDuration(item.duration))
                    .fontSize(12)
                    .fontColor('#999999')
                }
              }
              .width('100%')
              .height(80)
              .padding({ left: 16, right: 16 })
              .backgroundColor(this.currentSong && this.currentSong.id === item.id ? '#FFF5F5' : '#FFFFFF')
              .onClick(() => {
                this.playSong(item, index);
              })
            }
          }, (item: MusicItem) => item.id + item.source)
        }
        .width('100%')
        .layoutWeight(1)
        .divider({ strokeWidth: 1, color: '#F0F0F0' })
      } else {
        // ç©ºçŠ¶æ€
        Column() {
          Text('ğŸµ')
            .fontSize(80)
            .opacity(0.3)
          Text('ç‚¹å‡»æ¨èæ­Œå•')
            .fontSize(16)
            .fontColor('#666666')
            .margin({ top: 16 })
          Text('å¼€å§‹æ¢ç´¢éŸ³ä¹')
            .fontSize(14)
            .fontColor('#999999')
            .margin({ top: 8 })
        }
        .width('100%')
        .layoutWeight(1)
        .justifyContent(FlexAlign.Center)
      }
      // è¿·ä½ æ’­æ”¾å™¨
      if (this.currentSong) {
        MiniPlayer()
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#FFFFFF')
  }
}
