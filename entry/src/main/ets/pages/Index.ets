import { MusicItem } from '../services/MusicApiService';
import AudioPlayerService, { PlayState } from '../services/AudioPlayerService';
import MusicApiService from '../services/MusicApiService';
import { MiniPlayer } from '../components/MiniPlayer';
import promptAction from '@ohos.promptAction';
import router from '@ohos.router';

// ğŸ”¥ å®šä¹‰æ˜ç¡®çš„çŠ¶æ€æ¥å£
interface PlayerState {
  currentSong: MusicItem | null;
  playState: PlayState;
  currentTime: number;
  duration: number;
  playlist: MusicItem[];
  currentIndex: number;
}

@Entry
@Component
struct Index {
  @State searchKeyword: string = '';
  @State searchResults: MusicItem[] = [];
  @State isSearching: boolean = false;
  @StorageProp('currentSong') currentSong: MusicItem | null = null;
  @StorageProp('playState') playState: PlayState = PlayState.IDLE;
  @StorageProp('currentIndex') currentIndex: number = -1;

  aboutToAppear() {
    // ğŸ”¥ ä¿®å¤ï¼šä½¿ç”¨å®ä¾‹æ–¹æ³• + æ˜ç¡®ç±»å‹
    AudioPlayerService.getInstance().subscribe((state: PlayerState) => {
      AppStorage.setOrCreate('currentSong', state.currentSong);
      AppStorage.setOrCreate('playState', state.playState);
      AppStorage.setOrCreate('currentTime', state.currentTime);
      AppStorage.setOrCreate('duration', state.duration);
      AppStorage.setOrCreate('playlist', state.playlist);
      AppStorage.setOrCreate('currentIndex', state.currentIndex);
    });
  }

  async performSearch() {
    if (!this.searchKeyword.trim()) {
      promptAction.showToast({ message: 'è¯·è¾“å…¥æœç´¢å…³é”®è¯' });
      return;
    }

    this.isSearching = true;
    this.searchResults = [];

    try {
      const results = await MusicApiService.searchMusic(this.searchKeyword, 'netease');
      this.searchResults = results;
      console.info('[Index] æœç´¢ç»“æœ:', results.length);

      if (results.length === 0) {
        promptAction.showToast({ message: 'æœªæ‰¾åˆ°ç›¸å…³æ­Œæ›²' });
      }
    } catch (error) {
      console.error('[Index] æœç´¢å¤±è´¥:', error);
      promptAction.showToast({ message: 'æœç´¢å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ' });
    } finally {
      this.isSearching = false;
    }
  }

  async playSong(song: MusicItem, index: number) {
    console.info('[Index] ç‚¹å‡»æ’­æ”¾:', song.name);

    try {
      // ğŸ”¥ ä¿®å¤ï¼šä½¿ç”¨å®ä¾‹æ–¹æ³•
      await AudioPlayerService.getInstance().play(song, this.searchResults, index);
      console.info('[Index] æ’­æ”¾æœåŠ¡è°ƒç”¨æˆåŠŸ');

      await router.pushUrl({
        url: 'pages/PlayerPage'
      });

    } catch (error) {
      console.error('[Index] æ’­æ”¾å¤±è´¥:', JSON.stringify(error));
      promptAction.showToast({
        message: 'æ’­æ”¾å¤±è´¥'
      });
    }
  }

  formatDuration(seconds: number): string {
    const mins = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    return `${mins}:${secs.toString().padStart(2, '0')}`;
  }

  build() {
    Column() {
      // æœç´¢æ 
      Row() {
        TextInput({ placeholder: 'æœç´¢æ­Œæ›²ã€æ­Œæ‰‹', text: $$this.searchKeyword })
          .layoutWeight(1)
          .height(50)
          .fontSize(16)
          .backgroundColor('#F5F5F5')
          .borderRadius(25)
          .padding({ left: 20, right: 20 })
          .onSubmit(() => {
            this.performSearch();
          })

        Button({ type: ButtonType.Circle }) {
          Text('ğŸ”')
            .fontSize(20)
        }
        .width(50)
        .height(50)
        .backgroundColor('#FF6B6B')
        .margin({ left: 12 })
        .onClick(() => {
          this.performSearch();
        })
      }
      .width('100%')
      .padding(16)
      .backgroundColor('#FFFFFF')

      // åŠ è½½çŠ¶æ€
      if (this.isSearching) {
        Column() {
          LoadingProgress()
            .width(40)
            .height(40)
            .color('#FF6B6B')
          Text('æœç´¢ä¸­...')
            .fontSize(14)
            .fontColor('#999999')
            .margin({ top: 12 })
        }
        .width('100%')
        .height('100%')
        .justifyContent(FlexAlign.Center)
      } else if (this.searchResults.length > 0) {
        // æœç´¢ç»“æœåˆ—è¡¨
        List({ space: 0 }) {
          ForEach(this.searchResults, (item: MusicItem, index: number) => {
            ListItem() {
              Row() {
                Row() {
                  if (this.currentSong && this.currentSong.id === item.id && this.playState === PlayState.PLAYING) {
                    Text('â™«')
                      .fontSize(16)
                      .fontColor('#FF6B6B')
                      .fontWeight(FontWeight.Bold)
                      .margin({ right: 8 })
                  }
                  Text(`${index + 1}`)
                    .fontSize(14)
                    .fontColor('#999999')
                }
                .width(40)

                Column() {
                  Text(item.name)
                    .fontSize(16)
                    .fontWeight(FontWeight.Medium)
                    .maxLines(1)
                    .textOverflow({ overflow: TextOverflow.Ellipsis })
                    .width('100%')

                  Text(`${item.artist} - ${item.album || 'æœªçŸ¥ä¸“è¾‘'}`)
                    .fontSize(12)
                    .fontColor('#999999')
                    .maxLines(1)
                    .textOverflow({ overflow: TextOverflow.Ellipsis })
                    .margin({ top: 4 })
                    .width('100%')
                }
                .layoutWeight(1)
                .margin({ left: 12, right: 12 })
                .alignItems(HorizontalAlign.Start)

                if (item.duration) {
                  Text(this.formatDuration(item.duration))
                    .fontSize(12)
                    .fontColor('#999999')
                }
              }
              .width('100%')
              .height(70)
              .padding({ left: 16, right: 16 })
              .backgroundColor(this.currentSong && this.currentSong.id === item.id ? '#FFF5F5' : '#FFFFFF')
              .onClick(() => {
                this.playSong(item, index);
              })
            }
          }, (item: MusicItem) => item.id + item.source)
        }
        .width('100%')
        .layoutWeight(1)
        .divider({ strokeWidth: 1, color: '#F0F0F0' })
      } else {
        // ç©ºçŠ¶æ€
        Column() {
          Text('ğŸµ')
            .fontSize(80)
            .opacity(0.3)
          Text('æš‚æ— æœç´¢ç»“æœ')
            .fontSize(16)
            .fontColor('#999999')
            .margin({ top: 16 })
          Text('è¯•è¯•æœç´¢ä½ å–œæ¬¢çš„æ­Œæ›²')
            .fontSize(14)
            .fontColor('#CCCCCC')
            .margin({ top: 8 })
        }
        .width('100%')
        .layoutWeight(1)
        .justifyContent(FlexAlign.Center)
      }

      // è¿·ä½ æ’­æ”¾å™¨
      if (this.currentSong) {
        MiniPlayer()
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#FFFFFF')
  }
}
