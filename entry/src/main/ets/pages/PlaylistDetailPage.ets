/**
 * ğŸµ æ­Œå•è¯¦æƒ…é¡µ
 *
 * åŠŸèƒ½: æ˜¾ç¤ºæ­Œå•çš„æ­Œæ›²åˆ—è¡¨
 * - æ˜¾ç¤ºæ­Œå•ä¿¡æ¯(åç§°/æè¿°/å°é¢)
 * - ä½¿ç”¨æœ¬åœ°æ­Œæ›²æ•°æ®(é¿å…APIé¢‘ç‡é™åˆ¶)
 * - ç‚¹å‡»æ­Œæ›²æ’­æ”¾
 * - è¿”å›é¦–é¡µ
 */

import { MusicItem } from '../services/MusicApiService';
import AudioPlayerService, { PlayState } from '../services/AudioPlayerService';
import MusicApiService from '../services/MusicApiService';
import { MiniPlayer } from '../components/MiniPlayer';
import router from '@ohos.router';
import promptAction from '@ohos.promptAction';
import { TimeUtil } from '../utils/TimeUtil';
import { ErrorHandler } from '../utils/ErrorHandler';
import { LocalSongItem } from '../constants/LocalData';

// ğŸ”¥ æœ¬åœ°æ­Œæ›²æ˜¾ç¤ºé¡¹
interface DisplaySongItem {
  name: string;
  artist: string;
  album: string;
  duration: number;
}

@Entry
@Component
struct PlaylistDetailPage {
  @State playlistName: string = '';
  @State playlistDescription: string = '';
  @State playlistCover: string = '';
  @State localSongs: LocalSongItem[] = [];
  @State isLoading: boolean = false;
  @StorageProp('currentSong') currentSong: MusicItem | null = null;
  @StorageProp('playState') playState: PlayState = PlayState.IDLE;
  @StorageProp('currentIndex') currentIndex: number = -1;

  aboutToAppear() {
    // è·å–è·¯ç”±å‚æ•°
    const params = router.getParams() as Record<string, Object>;
    this.playlistName = params['name'] as string || '';
    this.playlistDescription = params['description'] as string || '';
    this.playlistCover = params['cover'] as string || '';
    this.localSongs = params['songs'] as LocalSongItem[] || [];

    console.info('[PlaylistDetail] æ­Œå•ä¿¡æ¯:', this.playlistName);
    console.info('[PlaylistDetail] æœ¬åœ°æ­Œæ›²æ•°é‡:', this.localSongs.length);
  }

  async playSongByName(songName: string, artist: string, index: number) {
    console.info('[PlaylistDetail] ===== ç‚¹å‡»æ’­æ”¾ =====');
    console.info('[PlaylistDetail] æ­Œæ›²å:', songName);
    console.info('[PlaylistDetail] æ­Œæ‰‹:', artist);

    // æ˜¾ç¤ºåŠ è½½æç¤º
    promptAction.showToast({ message: 'æ­£åœ¨åŠ è½½...' });

    try {
      // ä½¿ç”¨æ­Œæ›²åå’Œæ­Œæ‰‹æœç´¢
      const keyword = `${songName} ${artist}`;
      console.info('[PlaylistDetail] æœç´¢å…³é”®è¯:', keyword);

      const results = await MusicApiService.searchMusic(keyword, 'netease');
      console.info('[PlaylistDetail] æœç´¢ç»“æœæ•°é‡:', results.length);
      
      if (results.length > 0) {
        // ğŸ”¥ ä¼˜å…ˆé€‰æ‹©åŸå”±ç‰ˆæœ¬(æ­Œæ‰‹ååŒ¹é…çš„)
        let selectedSong = results[0];
        
        // å°è¯•æ‰¾åˆ°æ­Œæ‰‹ååŒ¹é…çš„ç‰ˆæœ¬
        for (const song of results) {
          if (song.artist.includes(artist) || artist.includes(song.artist)) {
            selectedSong = song;
            console.info('[PlaylistDetail] æ‰¾åˆ°åŸå”±ç‰ˆæœ¬:', song.name, '-', song.artist);
            break;
          }
        }
        
        console.info('[PlaylistDetail] é€‰æ‹©æ­Œæ›²:', selectedSong.name, '-', selectedSong.artist);
        console.info('[PlaylistDetail] æ­Œæ›²ID:', selectedSong.id);
        console.info('[PlaylistDetail] éŸ³ä¹æº:', selectedSong.source);

        await AudioPlayerService.getInstance().play(selectedSong, results, 0);
        console.info('[PlaylistDetail] âœ… æ’­æ”¾æœåŠ¡è°ƒç”¨æˆåŠŸ');

        await router.pushUrl({
          url: 'pages/PlayerPage'
        });
        console.info('[PlaylistDetail] âœ… å·²è·³è½¬åˆ°æ’­æ”¾å™¨é¡µé¢');
      } else {
        console.warn('[PlaylistDetail] âŒ æœªæ‰¾åˆ°æœç´¢ç»“æœ');
        promptAction.showToast({ message: 'æœªæ‰¾åˆ°è¯¥æ­Œæ›²,è¯·ç¨åé‡è¯•' });
      }

    } catch (error) {
      const err = error as Error;
      console.error('[PlaylistDetail] âŒ æ’­æ”¾å¤±è´¥:', err.message);
      console.error('[PlaylistDetail] é”™è¯¯å †æ ˆ:', err.stack);
      
      promptAction.showToast({
        message: `æ’­æ”¾å¤±è´¥: ${err.message}`,
        duration: 3000
      });
      
      const context: Record<string, Object> = {
        'songName': songName as Object,
        'artist': artist as Object,
        'error': err.message as Object
      };
      const appError = ErrorHandler.createAudioError('æ’­æ”¾å¤±è´¥', context);
      ErrorHandler.handle(appError);
    }
  }

  formatDuration(seconds: number): string {
    return TimeUtil.formatTime(seconds);
  }

  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆªæ 
      Row() {
        Button({ type: ButtonType.Circle }) {
          Text('â†')
            .fontSize(24)
            .fontColor('#333333')
        }
        .width(40)
        .height(40)
        .backgroundColor('#F5F5F5')
        .onClick(() => {
          router.back();
        })

        Text(this.playlistName)
          .fontSize(18)
          .fontWeight(FontWeight.Medium)
          .layoutWeight(1)
          .textAlign(TextAlign.Center)
          .maxLines(1)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
          .margin({ left: 12, right: 12 })

        // å ä½,ä¿æŒæ ‡é¢˜å±…ä¸­
        Column()
          .width(40)
          .height(40)
      }
      .width('100%')
      .padding(16)
      .backgroundColor('#FFFFFF')

      // å†…å®¹åŒºåŸŸ
      Column() {
        if (this.isLoading) {
          // åŠ è½½çŠ¶æ€
          Column() {
            LoadingProgress()
              .width(40)
              .height(40)
              .color('#FF6B6B')
            Text('åŠ è½½ä¸­...')
              .fontSize(14)
              .fontColor('#999999')
              .margin({ top: 12 })
          }
          .width('100%')
          .layoutWeight(1)
          .justifyContent(FlexAlign.Center)
        } else if (this.localSongs.length > 0) {
          // æ­Œæ›²åˆ—è¡¨
          Column() {
            // æ­Œå•å¤´éƒ¨ä¿¡æ¯
            Column() {
              // å°é¢
              Image($r(`app.media.${this.playlistCover}`))
                .width(120)
                .height(120)
                .borderRadius(12)
                .objectFit(ImageFit.Cover)
                .shadow({
                  radius: 12,
                  color: 'rgba(0, 0, 0, 0.15)',
                  offsetX: 0,
                  offsetY: 4
                })

              Text(this.playlistName)
                .fontSize(20)
                .fontWeight(FontWeight.Bold)
                .margin({ top: 16 })

              Text(this.playlistDescription)
                .fontSize(14)
                .fontColor('#999999')
                .margin({ top: 8 })

              Text(`å…± ${this.localSongs.length} é¦–æ­Œæ›²`)
                .fontSize(12)
                .fontColor('#999999')
                .margin({ top: 8 })
            }
            .width('100%')
            .padding(20)
            .backgroundColor('#FAFAFA')

            // æ­Œæ›²åˆ—è¡¨
            List({ space: 0 }) {
              ForEach(this.localSongs, (item: LocalSongItem, index: number) => {
                ListItem() {
                  Row() {
                    // éŸ³ä¹å›¾æ ‡
                    Column() {
                      Text('ğŸµ')
                        .fontSize(32)
                        .opacity(0.6)
                    }
                    .width(60)
                    .height(60)
                    .borderRadius(8)
                    .backgroundColor('#F5F5F5')
                    .justifyContent(FlexAlign.Center)
                    .margin({ right: 12 })

                    // æ’­æ”¾çŠ¶æ€å›¾æ ‡
                    if (this.currentSong &&
                        this.currentSong.name === item.name &&
                        this.currentSong.artist === item.artist &&
                        this.playState === PlayState.PLAYING) {
                      Text('â™«')
                        .fontSize(20)
                        .fontColor('#FF6B6B')
                        .fontWeight(FontWeight.Bold)
                        .margin({ right: 12 })
                    }

                    Column() {
                      Text(item.name)
                        .fontSize(16)
                        .fontWeight(FontWeight.Medium)
                        .maxLines(1)
                        .textOverflow({ overflow: TextOverflow.Ellipsis })
                        .width('100%')

                      Text(`${item.artist} - ${item.album}`)
                        .fontSize(12)
                        .fontColor('#999999')
                        .maxLines(1)
                        .textOverflow({ overflow: TextOverflow.Ellipsis })
                        .margin({ top: 4 })
                        .width('100%')
                    }
                    .layoutWeight(1)
                    .margin({ left: 12, right: 12 })
                    .alignItems(HorizontalAlign.Start)

                    Text(this.formatDuration(item.duration))
                      .fontSize(12)
                      .fontColor('#999999')
                  }
                  .width('100%')
                  .height(80)
                  .padding({ left: 16, right: 16 })
                  .backgroundColor(
                    this.currentSong &&
                    this.currentSong.name === item.name &&
                    this.currentSong.artist === item.artist
                      ? '#FFF5F5'
                      : '#FFFFFF'
                  )
                  .onClick(() => {
                    this.playSongByName(item.name, item.artist, index);
                  })
                }
              }, (item: LocalSongItem) => `${item.name}_${item.artist}`)
            }
            .width('100%')
            .layoutWeight(1)
            .divider({ strokeWidth: 1, color: '#F0F0F0' })
          }
          .width('100%')
          .layoutWeight(1)
        } else {
          // ç©ºçŠ¶æ€
          Column() {
            Text('ğŸµ')
              .fontSize(80)
              .opacity(0.3)
            Text('æš‚æ— æ­Œæ›²')
              .fontSize(16)
              .fontColor('#666666')
              .margin({ top: 16 })
          }
          .width('100%')
          .layoutWeight(1)
          .justifyContent(FlexAlign.Center)
        }
      }
      .width('100%')
      .layoutWeight(1)

      // è¿·ä½ æ’­æ”¾å™¨
      MiniPlayer()
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#FFFFFF')
  }
}