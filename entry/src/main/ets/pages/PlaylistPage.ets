/**
 * ğŸ“€ æ­Œå•é¡µé¢
 *
 * åŠŸèƒ½: æ˜¾ç¤ºæ‰€æœ‰æœ¬åœ°éŸ³ä¹
 * - æ˜¾ç¤ºæœ¬åœ°éŸ³ä¹åˆ—è¡¨
 * - æ”¯æŒæ’­æ”¾æœ¬åœ°éŸ³ä¹
 * - æ”¯æŒåˆ·æ–°éŸ³ä¹åº“
 * - æ”¯æŒç¼–è¾‘æ¨¡å¼(åˆ é™¤éŸ³ä¹)
 * - æ˜¾ç¤ºéŸ³ä¹æ•°é‡ç»Ÿè®¡
 */

import { MusicItem } from '../services/MusicApiService';
import { LocalMusicService } from '../services/LocalMusicService';
import AudioPlayerService, { PlayState } from '../services/AudioPlayerService';
import router from '@ohos.router';
import promptAction from '@ohos.promptAction';
import { TimeUtil } from '../utils/TimeUtil';

@Component
export struct PlaylistPage {
  @State localMusicList: MusicItem[] = [];
  @State displayList: MusicItem[] = []; // æ˜¾ç¤ºçš„åˆ—è¡¨(æœç´¢ç»“æœæˆ–å…¨éƒ¨)
  @State isLoading: boolean = false;
  @State isEditMode: boolean = false; // ç¼–è¾‘æ¨¡å¼
  @State selectedItems: Set<string> = new Set(); // é€‰ä¸­çš„éŸ³ä¹ID
  @State searchKeyword: string = ''; // æœç´¢å…³é”®è¯
  @StorageProp('currentSong') currentSong: MusicItem | null = null;
  @StorageProp('playState') playState: PlayState = PlayState.IDLE;

  async aboutToAppear() {
    await this.loadLocalMusic();
  }

  // åŠ è½½æœ¬åœ°éŸ³ä¹
  async loadLocalMusic() {
    this.isLoading = true;
    try {
      this.localMusicList = await LocalMusicService.scanLocalMusic();
      this.displayList = this.localMusicList;
      if (this.localMusicList.length === 0) {
        promptAction.showToast({ message: 'æœªæ‰¾åˆ°æœ¬åœ°éŸ³ä¹æ–‡ä»¶' });
      }
    } catch (error) {
      console.error('[PlaylistPage] åŠ è½½å¤±è´¥:', error);
      promptAction.showToast({ message: 'åŠ è½½æœ¬åœ°éŸ³ä¹å¤±è´¥' });
    } finally {
      this.isLoading = false;
    }
  }

  // åˆ·æ–°éŸ³ä¹åº“
  async refreshMusic() {
    this.isLoading = true;
    try {
      this.localMusicList = await LocalMusicService.refresh();
      this.displayList = this.localMusicList;
      this.searchKeyword = ''; // æ¸…ç©ºæœç´¢
      promptAction.showToast({ message: `åˆ·æ–°å®Œæˆ,å…±${this.localMusicList.length}é¦–` });
      // é€€å‡ºç¼–è¾‘æ¨¡å¼
      this.isEditMode = false;
      this.selectedItems.clear();
    } catch (error) {
      console.error('[PlaylistPage] åˆ·æ–°å¤±è´¥:', error);
      promptAction.showToast({ message: 'åˆ·æ–°å¤±è´¥' });
    } finally {
      this.isLoading = false;
    }
  }

  // æœç´¢æœ¬åœ°éŸ³ä¹
  performSearch() {
    if (!this.searchKeyword.trim()) {
      this.displayList = this.localMusicList;
      return;
    }

    const keyword = this.searchKeyword.toLowerCase();
    this.displayList = this.localMusicList.filter(song =>
      song.name.toLowerCase().includes(keyword) ||
      song.artist.toLowerCase().includes(keyword)
    );

    if (this.displayList.length === 0) {
      promptAction.showToast({ message: 'æœªæ‰¾åˆ°ç›¸å…³æ­Œæ›²' });
    }
  }

  // æ’­æ”¾æ­Œæ›²
  async playSong(song: MusicItem, index: number) {
    try {
      // ä½¿ç”¨displayListä½œä¸ºæ’­æ”¾åˆ—è¡¨
      await AudioPlayerService.getInstance().play(song, this.displayList, index);
      await router.pushUrl({ url: 'pages/PlayerPage' });
    } catch (error) {
      console.error('[PlaylistPage] æ’­æ”¾å¤±è´¥:', error);
      promptAction.showToast({ message: 'æ’­æ”¾å¤±è´¥' });
    }
  }

  // åˆ‡æ¢ç¼–è¾‘æ¨¡å¼
  toggleEditMode() {
    this.isEditMode = !this.isEditMode;
    if (!this.isEditMode) {
      this.selectedItems.clear();
    }
  }

  // åˆ‡æ¢é€‰ä¸­çŠ¶æ€
  toggleSelection(musicId: string) {
    if (this.selectedItems.has(musicId)) {
      this.selectedItems.delete(musicId);
    } else {
      this.selectedItems.add(musicId);
    }
    // è§¦å‘UIæ›´æ–°
    this.selectedItems = new Set(this.selectedItems);
  }

  // å…¨é€‰/å–æ¶ˆå…¨é€‰
  toggleSelectAll() {
    if (this.selectedItems.size === this.displayList.length) {
      this.selectedItems.clear();
    } else {
      this.selectedItems = new Set(this.displayList.map(item => item.id));
    }
  }

  // åˆ é™¤é€‰ä¸­çš„éŸ³ä¹
  deleteSelected() {
    if (this.selectedItems.size === 0) {
      promptAction.showToast({ message: 'è¯·é€‰æ‹©è¦åˆ é™¤çš„éŸ³ä¹' });
      return;
    }

    const count = LocalMusicService.removeBatchFromList(Array.from(this.selectedItems));
    this.localMusicList = LocalMusicService.getLocalMusicList();
    this.displayList = this.localMusicList;
    this.searchKeyword = ''; // æ¸…ç©ºæœç´¢
    this.selectedItems.clear();
    this.isEditMode = false;
    promptAction.showToast({ message: `å·²ä»åˆ—è¡¨ç§»é™¤${count}é¦–æ­Œæ›²` });
  }

  formatDuration(seconds: number): string {
    return TimeUtil.formatTime(seconds);
  }

  build() {
    Column() {
      // æ ‡é¢˜æ 
      Row() {
        if (this.isEditMode) {
          // ç¼–è¾‘æ¨¡å¼æ ‡é¢˜æ 
          Button('å–æ¶ˆ')
            .fontSize(16)
            .fontColor('#666666')
            .backgroundColor(Color.Transparent)
            .onClick(() => {
              this.toggleEditMode();
            })

          Text(`å·²é€‰${this.selectedItems.size}é¦–`)
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .fontColor('#333333')
            .layoutWeight(1)
            .textAlign(TextAlign.Center)

          Button('åˆ é™¤')
            .fontSize(16)
            .fontColor('#FF6B6B')
            .backgroundColor(Color.Transparent)
            .onClick(() => {
              this.deleteSelected();
            })
        } else {
          // æ­£å¸¸æ¨¡å¼æ ‡é¢˜æ 
          Text('æœ¬åœ°éŸ³ä¹')
            .fontSize(24)
            .fontWeight(FontWeight.Bold)
            .fontColor('#333333')
            .layoutWeight(1)

          // ç¼–è¾‘æŒ‰é’®
          Button({ type: ButtonType.Circle }) {
            Text('âœï¸')
              .fontSize(18)
          }
          .width(44)
          .height(44)
          .backgroundColor('#F5F5F5')
          .margin({ right: 8 })
          .onClick(() => {
            if (this.localMusicList.length > 0) {
              this.toggleEditMode();
            } else {
              promptAction.showToast({ message: 'æš‚æ— éŸ³ä¹å¯ç¼–è¾‘' });
            }
          })

          // åˆ·æ–°æŒ‰é’®
          Button({ type: ButtonType.Circle }) {
            Text('ğŸ”„')
              .fontSize(20)
          }
          .width(44)
          .height(44)
          .backgroundColor('#F5F5F5')
          .onClick(() => {
            this.refreshMusic();
          })
        }
      }
      .width('100%')
      .padding(16)
      .backgroundColor('#FFFFFF')

      // æœç´¢æ  - åªåœ¨éç¼–è¾‘æ¨¡å¼æ˜¾ç¤º
      if (!this.isEditMode) {
        Row() {
          TextInput({ placeholder: 'æœç´¢æœ¬åœ°éŸ³ä¹', text: $$this.searchKeyword })
            .layoutWeight(1)
            .height(44)
            .fontSize(14)
            .backgroundColor('#F5F5F5')
            .borderRadius(22)
            .padding({ left: 16, right: 16 })
            .onChange((value: string) => {
              this.performSearch();
            })

          Button({ type: ButtonType.Circle }) {
            Text('ğŸ”')
              .fontSize(18)
          }
          .width(44)
          .height(44)
          .backgroundColor('#FF6B6B')
          .margin({ left: 8 })
          .onClick(() => {
            this.performSearch();
          })
        }
        .width('100%')
        .padding({ left: 16, right: 16, bottom: 12 })
      }

      // ç»Ÿè®¡ä¿¡æ¯å’Œå…¨é€‰æŒ‰é’®
      Row() {
        if (this.isEditMode) {
          Checkbox()
            .select(this.selectedItems.size === this.displayList.length && this.displayList.length > 0)
            .onChange(() => {
              this.toggleSelectAll();
            })
          Text('å…¨é€‰')
            .fontSize(14)
            .fontColor('#666666')
            .margin({ left: 8 })
        }

        Text(`å…± ${this.displayList.length} é¦–æ­Œæ›²${this.searchKeyword ? ' (æœç´¢ç»“æœ)' : ''}`)
          .fontSize(14)
          .fontColor('#999999')
          .layoutWeight(1)
          .textAlign(this.isEditMode ? TextAlign.End : TextAlign.Start)
      }
      .width('100%')
      .padding({ left: 16, right: 16, bottom: 12 })

      // åŠ è½½çŠ¶æ€
      if (this.isLoading) {
        Column() {
          LoadingProgress()
            .width(40)
            .height(40)
            .color('#FF6B6B')
          Text('åŠ è½½ä¸­...')
            .fontSize(14)
            .fontColor('#999999')
            .margin({ top: 12 })
        }
        .width('100%')
        .layoutWeight(1)
        .justifyContent(FlexAlign.Center)
      } else if (this.displayList.length === 0 && !this.searchKeyword) {
        // ç©ºçŠ¶æ€
        Column() {
          Text('ğŸ“')
            .fontSize(80)
            .opacity(0.3)
          Text('æš‚æ— æœ¬åœ°éŸ³ä¹')
            .fontSize(16)
            .fontColor('#666666')
            .margin({ top: 16 })
          Text('è¯·å°†éŸ³ä¹æ–‡ä»¶æ”¾å…¥Musicæˆ–Downloadæ–‡ä»¶å¤¹')
            .fontSize(12)
            .fontColor('#999999')
            .margin({ top: 8 })

          Button('åˆ·æ–°')
            .margin({ top: 24 })
            .onClick(() => {
              this.refreshMusic();
            })
        }
        .width('100%')
        .layoutWeight(1)
        .justifyContent(FlexAlign.Center)
      } else if (this.displayList.length === 0 && this.searchKeyword) {
        // æœç´¢æ— ç»“æœ
        Column() {
          Text('ğŸ”')
            .fontSize(80)
            .opacity(0.3)
          Text('æœªæ‰¾åˆ°ç›¸å…³æ­Œæ›²')
            .fontSize(16)
            .fontColor('#666666')
            .margin({ top: 16 })
          Text(`æœç´¢"${this.searchKeyword}"æ— ç»“æœ`)
            .fontSize(12)
            .fontColor('#999999')
            .margin({ top: 8 })

          Button('æ¸…ç©ºæœç´¢')
            .margin({ top: 24 })
            .onClick(() => {
              this.searchKeyword = '';
              this.performSearch();
            })
        }
        .width('100%')
        .layoutWeight(1)
        .justifyContent(FlexAlign.Center)
      } else {
        // éŸ³ä¹åˆ—è¡¨
        List({ space: 0 }) {
          ForEach(this.displayList, (item: MusicItem, index: number) => {
            ListItem() {
              Row() {
                // ç¼–è¾‘æ¨¡å¼:æ˜¾ç¤ºå¤é€‰æ¡†
                if (this.isEditMode) {
                  Checkbox()
                    .select(this.selectedItems.has(item.id))
                    .onChange(() => {
                      this.toggleSelection(item.id);
                    })
                    .margin({ right: 12 })
                } else {
                  // æ­£å¸¸æ¨¡å¼:æ˜¾ç¤ºåºå·å’Œæ’­æ”¾çŠ¶æ€
                  Row() {
                    if (this.currentSong && this.currentSong.id === item.id && this.playState === PlayState.PLAYING) {
                      Text('â™«')
                        .fontSize(16)
                        .fontColor('#FF6B6B')
                        .fontWeight(FontWeight.Bold)
                        .margin({ right: 8 })
                    }
                    Text(`${index + 1}`)
                      .fontSize(14)
                      .fontColor('#999999')
                  }
                  .width(50)
                }

                // éŸ³ä¹å›¾æ ‡
                Column() {
                  Text('ğŸµ')
                    .fontSize(24)
                }
                .width(50)
                .height(50)
                .borderRadius(8)
                .backgroundColor('#F5F5F5')
                .justifyContent(FlexAlign.Center)
                .margin({ right: 12 })

                // æ­Œæ›²ä¿¡æ¯
                Column() {
                  Text(item.name)
                    .fontSize(16)
                    .fontWeight(FontWeight.Medium)
                    .maxLines(1)
                    .textOverflow({ overflow: TextOverflow.Ellipsis })
                    .width('100%')

                  Text(item.artist)
                    .fontSize(12)
                    .fontColor('#999999')
                    .maxLines(1)
                    .textOverflow({ overflow: TextOverflow.Ellipsis })
                    .margin({ top: 4 })
                    .width('100%')
                }
                .layoutWeight(1)
                .margin({ left: 12, right: 12 })
                .alignItems(HorizontalAlign.Start)

                // æ—¶é•¿
                if (item.duration && !this.isEditMode) {
                  Text(this.formatDuration(item.duration))
                    .fontSize(12)
                    .fontColor('#999999')
                }
              }
              .width('100%')
              .height(70)
              .padding({ left: 16, right: 16 })
              .backgroundColor(
                this.isEditMode && this.selectedItems.has(item.id) ? '#FFF5F5' :
                this.currentSong && this.currentSong.id === item.id ? '#FFF5F5' : '#FFFFFF'
              )
              .onClick(() => {
                if (this.isEditMode) {
                  this.toggleSelection(item.id);
                } else {
                  this.playSong(item, index);
                }
              })
            }
          }, (item: MusicItem) => item.id)
        }
        .width('100%')
        .layoutWeight(1)
        .divider({ strokeWidth: 1, color: '#F0F0F0' })
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#FFFFFF')
  }
}