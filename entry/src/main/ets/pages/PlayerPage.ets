/**
 * ğŸµ æ’­æ”¾å™¨é¡µé¢
 *
 * åŠŸèƒ½: å®Œæ•´çš„éŸ³ä¹æ’­æ”¾é¡µé¢
 * - æ˜¾ç¤ºå°é¢(å¸¦æ—‹è½¬åŠ¨ç”»)
 * - æ˜¾ç¤ºæ­Œè¯(å®æ—¶é«˜äº®æ»šåŠ¨)
 * - æ’­æ”¾æ§åˆ¶(æ’­æ”¾/æš‚åœ/ä¸Šä¸€æ›²/ä¸‹ä¸€æ›²)
 * - è¿›åº¦æ¡æ‹–åŠ¨
 * - éŸ³è´¨åˆ‡æ¢
 * - æ’­æ”¾åˆ—è¡¨æ˜¾ç¤º
 */

import MusicApiService, { MusicItem } from '../services/MusicApiService';
import AudioPlayerService, { PlayState } from '../services/AudioPlayerService';
import { LyricParser, LyricLine } from '../utils/LyricParser';
import router from '@ohos.router';
import promptAction from '@ohos.promptAction';
import { TimeUtil } from '../utils/TimeUtil';

// ğŸ”¥ ä¼˜åŒ–åçš„æ­Œè¯åˆ—è¡¨é¡¹ç»„ä»¶(ä½¿ç”¨@Reusableå‡å°‘é‡æ¸²æŸ“)
@Reusable
@Component
struct LyricItem {
  @Prop text: string;
  @Prop isActive: boolean;

  build() {
    Text(this.text)
      .fontSize(this.isActive ? 20 : 14)
      .fontColor(this.isActive ? '#1E90FF' : '#999999')
      .fontWeight(this.isActive ? FontWeight.Bold : FontWeight.Normal)
      .textAlign(TextAlign.Center)
      .width('100%')
      .padding({ top: 4, bottom: 4 })
      .transition({ type: TransitionType.All, opacity: 1 })
      .animation({ duration: 300 })
  }
}

@Entry
@Component
struct PlayerPage {
  @Watch('onSongChange')
  @StorageLink('currentSong') currentSong: MusicItem | null = null;
  @Watch('onPlayStateChange')
  @StorageLink('playState') playState: PlayState = PlayState.IDLE;
  @Watch('onTimeChange')
  @StorageLink('currentTime') currentTime: number = 0;
  @StorageLink('duration') duration: number = 0;
  @StorageLink('currentIndex') currentIndex: number = -1;
  @StorageLink('playlist') playlist: MusicItem[] = [];

  @State coverUrl: string = '';
  @State lyrics: LyricLine[] = [];
  @State currentLyricIndex: number = -1;
  @State selectedQuality: number = 320;
  @State isUserDragging: boolean = false;
  @State showQualityMenu: boolean = false;
  @State rotateAngle: number = 0;
  @State isRotating: boolean = false;
  @State showLyrics: boolean = false;

  private scroller: Scroller = new Scroller();
  private rotationTimer: number = -1;
  private rotationId: number = 0;
  private lastSongId: string = '';  // ğŸ”¥ è®°å½•ä¸Šä¸€é¦–æ­Œæ›²ID,é˜²æ­¢é‡å¤è§¦å‘
  private isInitializing: boolean = true;  // ğŸ”¥ æ ‡è®°æ˜¯å¦æ­£åœ¨åˆå§‹åŒ–

  async aboutToAppear(): Promise<void> {
    console.info('[PlayerPage] ===== é¡µé¢åŠ è½½ =====');
    console.info('[PlayerPage] å½“å‰æ­Œæ›²:', this.currentSong?.name);
    console.info('[PlayerPage] æ’­æ”¾çŠ¶æ€:', this.playState);
    console.info('[PlayerPage] å½“å‰ç´¢å¼•:', this.currentIndex);

    // ğŸ”¥ è®°å½•å½“å‰æ­Œæ›²ID,é¿å…onSongChangeé‡å¤å¤„ç†
    this.lastSongId = this.currentSong?.id || '';

    // ğŸ”¥ ç«‹å³åŠ è½½å°é¢
    if (this.currentSong?.picId && this.currentSong?.source) {
      try {
        const coverUrl = await MusicApiService.getPicUrl(
          this.currentSong.source,
          this.currentSong.picId,
          500
        );
        console.info('[PlayerPage] åˆå§‹å°é¢åŠ è½½æˆåŠŸ');
        this.coverUrl = coverUrl;
      } catch (error) {
        const err = error as Error;
        console.error('[PlayerPage] åˆå§‹å°é¢åŠ è½½å¤±è´¥:', err.message);
        this.coverUrl = '';
      }
    }

    // ğŸ”¥ åŠ è½½æ­Œè¯
    await this.loadLyrics();

    // ğŸ”¥ å»¶è¿Ÿåˆå§‹åŒ–,ç¡®ä¿çŠ¶æ€åŒæ­¥å®Œæˆ
    setTimeout(() => {
      this.isInitializing = false;
      console.info('[PlayerPage] åˆå§‹åŒ–å®Œæˆ,æ’­æ”¾çŠ¶æ€:', this.playState);
      
      // å¦‚æœæ­£åœ¨æ’­æ”¾,å¯åŠ¨æ—‹è½¬
      if (this.playState === PlayState.PLAYING && this.currentSong) {
        console.info('[PlayerPage] é¡µé¢åŠ è½½æ—¶å¯åŠ¨æ—‹è½¬');
        this.startRotation();
      }
    }, 100);
  }

  async onSongChange(): Promise<void> {
    // ğŸ”¥ åˆå§‹åŒ–æœŸé—´è·³è¿‡å¤„ç†
    if (this.isInitializing) {
      console.info('[PlayerPage] åˆå§‹åŒ–æœŸé—´,è·³è¿‡onSongChange');
      return;
    }

    // ğŸ”¥ é˜²æ­¢é‡å¤è§¦å‘
    const currentSongId = this.currentSong?.id || '';
    if (currentSongId === this.lastSongId) {
      console.info('[PlayerPage] ç›¸åŒæ­Œæ›²,è·³è¿‡å¤„ç†');
      return;
    }
    this.lastSongId = currentSongId;

    console.info('[PlayerPage] ===== åˆ‡æ­Œè§¦å‘ =====');
    console.info('[PlayerPage] æ­Œæ›²å:', this.currentSong?.name);
    console.info('[PlayerPage] æ­Œæ›²ID:', this.currentSong?.id);
    console.info('[PlayerPage] å½“å‰ç´¢å¼•:', this.currentIndex);
    console.info('[PlayerPage] æ’­æ”¾çŠ¶æ€:', this.playState);

    // å…ˆåœæ­¢æ—‹è½¬
    this.stopRotation();
    
    // ç«‹å³é‡ç½®è§’åº¦ä¸º0
    animateTo({ duration: 0 }, () => {
      this.rotateAngle = 0;
    });
    console.info('[PlayerPage] è§’åº¦å·²é‡ç½®ä¸º0');
    
    this.coverUrl = '';

    if (this.currentSong?.picId && this.currentSong?.source) {
      try {
        const newCover = await MusicApiService.getPicUrl(
          this.currentSong.source,
          this.currentSong.picId,
          500
        );
        console.info('[PlayerPage] å°é¢åŠ è½½æˆåŠŸ');
        this.coverUrl = newCover;
      } catch (error) {
        const err = error as Error;
        console.error('[PlayerPage] è·å–å°é¢å¤±è´¥:', err.message);
        this.coverUrl = '';
      }
    }

    await this.loadLyrics();
    this.currentLyricIndex = -1;

    console.info('[PlayerPage] åˆ‡æ­Œå®Œæˆ');
  }


  onPlayStateChange(): void {
    console.info('[PlayerPage] ===== æ’­æ”¾çŠ¶æ€å˜åŒ– =====');
    console.info('[PlayerPage] æ–°çŠ¶æ€:', this.playState);
    console.info('[PlayerPage] å½“å‰æ—‹è½¬çŠ¶æ€:', this.isRotating);

    if (this.playState === PlayState.PLAYING) {
      console.info('[PlayerPage] çŠ¶æ€å˜ä¸º PLAYINGï¼Œå¯åŠ¨æ—‹è½¬');
      this.startRotation();
    } else if (this.playState === PlayState.PAUSED) {
      console.info('[PlayerPage] çŠ¶æ€å˜ä¸º PAUSEDï¼Œåœæ­¢æ—‹è½¬');
      this.stopRotation();
    } else if (this.playState === PlayState.LOADING) {
      console.info('[PlayerPage] çŠ¶æ€å˜ä¸º LOADINGï¼Œåœæ­¢æ—‹è½¬');
      this.stopRotation();
    } else {
      console.info('[PlayerPage] çŠ¶æ€å˜ä¸ºå…¶ä»–:', this.playState);
      this.stopRotation();
    }
  }

  startRotation(): void {
    console.info('[PlayerPage] ===== startRotation è°ƒç”¨ =====');
    console.info('[PlayerPage] å½“å‰ isRotating:', this.isRotating);
    console.info('[PlayerPage] å½“å‰ rotateAngle:', this.rotateAngle);

    // ğŸ”¥ å¦‚æœå·²ç»åœ¨æ—‹è½¬ï¼Œç›´æ¥è¿”å›
    if (this.isRotating) {
      console.info('[PlayerPage] å·²åœ¨æ—‹è½¬ï¼Œè·³è¿‡é‡å¤å¯åŠ¨');
      return;
    }

    this.isRotating = true;
    this.rotationId++;  // ç”Ÿæˆæ–°çš„æ—‹è½¬ID
    const currentRotationId = this.rotationId;
    console.info('[PlayerPage] å¯åŠ¨æ–°æ—‹è½¬ä»»åŠ¡, ID:', currentRotationId);

    // ğŸ”¥ é€’å½’å‡½æ•°å®ç°æ— é™æ—‹è½¬
    const rotate = () => {
      // æ£€æŸ¥æ˜¯å¦åº”è¯¥åœæ­¢
      if (!this.isRotating || this.rotationId !== currentRotationId) {
        console.info('[PlayerPage] æ—‹è½¬ä»»åŠ¡', currentRotationId, 'å·²å–æ¶ˆ');
        return;
      }

      console.info('[PlayerPage] å¼€å§‹æ—‹è½¬åŠ¨ç”», ä»', this.rotateAngle, 'åº¦åˆ° 360 åº¦');
      
      animateTo({
        duration: 60000,  // 60ç§’è½¬360åº¦
        curve: Curve.Linear,
        onFinish: () => {
          console.info('[PlayerPage] åŠ¨ç”»å®Œæˆå›è°ƒ, ID:', currentRotationId);
          // æ£€æŸ¥æ˜¯å¦åº”è¯¥ç»§ç»­
          if (this.rotationId === currentRotationId && this.isRotating) {
            console.info('[PlayerPage] å®Œæˆä¸€åœˆï¼Œé‡ç½®è§’åº¦å¹¶ç»§ç»­');
            // ç«‹å³é‡ç½®è§’åº¦
            animateTo({ duration: 0 }, () => {
              this.rotateAngle = 0;
            });
            // çŸ­æš‚å»¶è¿Ÿåç»§ç»­ä¸‹ä¸€åœˆ
            setTimeout(() => {
              if (this.rotationId === currentRotationId && this.isRotating) {
                rotate();
              }
            }, 50);
          } else {
            console.info('[PlayerPage] æ—‹è½¬ä»»åŠ¡', currentRotationId, 'åœ¨å›è°ƒä¸­è¢«å–æ¶ˆ');
          }
        }
      }, () => {
        this.rotateAngle = 360;
        console.info('[PlayerPage] è®¾ç½®ç›®æ ‡è§’åº¦: 360');
      });
    };

    // ç«‹å³å¯åŠ¨ç¬¬ä¸€åœˆ
    console.info('[PlayerPage] ç«‹å³å¯åŠ¨ç¬¬ä¸€åœˆæ—‹è½¬');
    rotate();
  }


  stopRotation(): void {
    console.info('[PlayerPage] ===== stopRotation è°ƒç”¨ =====');
    console.info('[PlayerPage] å½“å‰è§’åº¦:', this.rotateAngle);
    console.info('[PlayerPage] æ˜¯å¦æ­£åœ¨æ—‹è½¬:', this.isRotating);

    if (!this.isRotating) {
      console.info('[PlayerPage] æ²¡æœ‰åœ¨æ—‹è½¬ï¼Œæ— éœ€åœæ­¢');
      return;
    }

    console.info('[PlayerPage] åœæ­¢æ—‹è½¬åŠ¨ç”»');
    this.isRotating = false;

    // ğŸ”¥ ä¿®å¤ï¼šä½¿ç”¨ animateTo ç«‹å³åœæ­¢åŠ¨ç”»
    animateTo({ duration: 0 }, () => {
      // ä¿æŒå½“å‰è§’åº¦ä¸å˜
      console.info('[PlayerPage] åŠ¨ç”»å·²åœæ­¢ï¼Œä¿æŒè§’åº¦:', this.rotateAngle);
    });
  }


  onTimeChange(): void {
    // ğŸ”¥ æ·»åŠ æ—¥å¿—,ç¡®è®¤æ—¶é—´æ›´æ–°è§¦å‘
    if (this.lyrics.length > 0) {
      this.updateLyricHighlight();
    }
  }

  async loadLyrics(): Promise<void> {
    if (!this.currentSong) {
      return;
    }

    try {
      const lyricData = await MusicApiService.getLyric(
        this.currentSong.source,
        this.currentSong.lyricId || this.currentSong.id
      );

      if (lyricData && lyricData.lyric) {
        this.lyrics = LyricParser.parse(lyricData.lyric);
        console.info('[PlayerPage] æ­Œè¯åŠ è½½æˆåŠŸï¼Œè¡Œæ•°:', this.lyrics.length);
      } else {
        this.lyrics = [];
        console.info('[PlayerPage] æ²¡æœ‰æ­Œè¯æ•°æ®');
      }
    } catch (error) {
      const err = error as Error;
      console.error('[PlayerPage] åŠ è½½æ­Œè¯å¤±è´¥:', err.message);
      this.lyrics = [];
    }
  }

  updateLyricHighlight(): void {
    if (this.lyrics.length === 0) {
      return;
    }

    const newIndex = LyricParser.getCurrentIndex(this.lyrics, this.currentTime);

    if (newIndex !== this.currentLyricIndex) {
      const oldIndex = this.currentLyricIndex;
      this.currentLyricIndex = newIndex;
      
      console.info('[PlayerPage] æ­Œè¯é«˜äº®æ›´æ–°:', oldIndex, 'â†’', newIndex, 'æ—¶é—´:', this.currentTime.toFixed(1));

      if (newIndex >= 0 && !this.isUserDragging && this.showLyrics) {
        this.scroller.scrollToIndex(newIndex, true, ScrollAlign.CENTER);
      }
    }
  }

  formatTime(seconds: number): string {
    return TimeUtil.formatTime(seconds);
  }

  togglePlay(): void {
    console.info('[PlayerPage] ===== åˆ‡æ¢æ’­æ”¾/æš‚åœ =====');
    AudioPlayerService.getInstance().togglePlay();
  }

  previousSong(): void {
    console.info('[PlayerPage] ===== ç‚¹å‡»ä¸Šä¸€æ›² =====');
    console.info('[PlayerPage] å½“å‰ç´¢å¼•:', this.currentIndex);
    console.info('[PlayerPage] æ’­æ”¾åˆ—è¡¨é•¿åº¦:', this.playlist.length);

    if (this.currentIndex > 0) {
      const prevIndex = this.currentIndex - 1;
      const prevSong = this.playlist[prevIndex];

      console.info('[PlayerPage] ç›®æ ‡æ­Œæ›²:', prevSong.name);
      console.info('[PlayerPage] ç›®æ ‡ç´¢å¼•:', prevIndex);
      console.info('[PlayerPage] ç›®æ ‡æ­Œæ›²ID:', prevSong.id);

      AudioPlayerService.getInstance().play(prevSong, this.playlist, prevIndex)
        .then(() => {
          console.info('[PlayerPage] âœ… æ’­æ”¾ä¸Šä¸€é¦–æˆåŠŸ');
        })
        .catch((error: Error) => {
          console.error('[PlayerPage] âŒ æ’­æ”¾ä¸Šä¸€é¦–å¤±è´¥:', error.message);
          promptAction.showToast({ message: 'æ’­æ”¾å¤±è´¥' });
        });
    } else {
      console.warn('[PlayerPage] å·²ç»æ˜¯ç¬¬ä¸€é¦–æ­Œæ›²');
      promptAction.showToast({ message: 'å·²ç»æ˜¯ç¬¬ä¸€é¦–æ­Œæ›²' });
    }
  }

  nextSong(): void {
    console.info('[PlayerPage] ===== ç‚¹å‡»ä¸‹ä¸€æ›² =====');
    console.info('[PlayerPage] å½“å‰ç´¢å¼•:', this.currentIndex);
    console.info('[PlayerPage] æ’­æ”¾åˆ—è¡¨é•¿åº¦:', this.playlist.length);

    if (this.currentIndex < this.playlist.length - 1) {
      const nextIndex = this.currentIndex + 1;
      const nextSong = this.playlist[nextIndex];

      console.info('[PlayerPage] ç›®æ ‡æ­Œæ›²:', nextSong.name);
      console.info('[PlayerPage] ç›®æ ‡ç´¢å¼•:', nextIndex);
      console.info('[PlayerPage] ç›®æ ‡æ­Œæ›²ID:', nextSong.id);

      AudioPlayerService.getInstance().play(nextSong, this.playlist, nextIndex)
        .then(() => {
          console.info('[PlayerPage] âœ… æ’­æ”¾ä¸‹ä¸€é¦–æˆåŠŸ');
        })
        .catch((error: Error) => {
          console.error('[PlayerPage] âŒ æ’­æ”¾ä¸‹ä¸€é¦–å¤±è´¥:', error.message);
          promptAction.showToast({ message: 'æ’­æ”¾å¤±è´¥' });
        });
    } else {
      console.warn('[PlayerPage] å·²ç»æ˜¯æœ€åä¸€é¦–æ­Œæ›²');
      promptAction.showToast({ message: 'å·²ç»æ˜¯æœ€åä¸€é¦–æ­Œæ›²' });
    }
  }

  onProgressChange(value: number): void {
    this.isUserDragging = true;
    AudioPlayerService.getInstance().seek(value);
    setTimeout(() => {
      this.isUserDragging = false;
    }, 500);
  }

  changeQuality(quality: number): void {
    console.info('[PlayerPage] ===== åˆ‡æ¢éŸ³è´¨ =====');
    console.info('[PlayerPage] æ–°éŸ³è´¨:', quality);

    this.selectedQuality = quality;
    AudioPlayerService.getInstance().setQuality(quality);

    if (this.currentSong) {
      const currentTime = this.currentTime;
      AudioPlayerService.getInstance().play(this.currentSong, this.playlist, this.currentIndex)
        .then(() => {
          AudioPlayerService.getInstance().seek(currentTime);
          promptAction.showToast({ message: 'éŸ³è´¨åˆ‡æ¢æˆåŠŸ' });
        })
        .catch((error: Error) => {
          console.error('[PlayerPage] åˆ‡æ¢éŸ³è´¨å¤±è´¥:', error.message);
          promptAction.showToast({ message: 'éŸ³è´¨åˆ‡æ¢å¤±è´¥' });
        });
    }
    this.showQualityMenu = false;
  }

  aboutToDisappear(): void {
    console.info('[PlayerPage] ===== é¡µé¢é”€æ¯ =====');
    this.stopRotation();
  }

  build() {
    Column() {
      Row() {
        Button({ type: ButtonType.Circle }) {
          Text('â†')
            .fontSize(24)
            .fontColor('#333333')
        }
        .width(40)
        .height(40)
        .backgroundColor('#F5F5F5')
        .onClick(() => {
          try {
            router.back();
          } catch (error) {
            const err = error as Error;
            console.error('[PlayerPage] è¿”å›å¤±è´¥:', err.message);
          }
        })

        Text(this.currentSong?.name || 'æ’­æ”¾å™¨')
          .fontSize(18)
          .fontWeight(FontWeight.Medium)
          .layoutWeight(1)
          .textAlign(TextAlign.Center)
          .maxLines(1)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
          .margin({ left: 12, right: 12 })

        Button({ type: ButtonType.Normal }) {
          Row() {
            Text(this.selectedQuality === 128 ? 'æ ‡å‡†'
              : this.selectedQuality === 192 ? 'è¾ƒé«˜'
                : this.selectedQuality === 320 ? 'é«˜å“'
                  : 'æ— æŸ')
              .fontSize(12)
              .fontColor('#FF6B6B')
            Text(' â–¼')
              .fontSize(10)
              .fontColor('#FF6B6B')
          }
        }
        .width(80)
        .height(36)
        .backgroundColor('#FFF0F0')
        .borderRadius(18)
        .onClick(() => {
          this.showQualityMenu = !this.showQualityMenu;
        })
      }
      .width('100%')
      .padding(16)
      .backgroundColor('#FFFFFF')
      .zIndex(10)

      if (this.showQualityMenu) {
        Column() {
          Button('æ ‡å‡† 128K')
            .width('100%')
            .height(44)
            .backgroundColor(this.selectedQuality === 128 ? '#FFF0F0' : '#FFFFFF')
            .fontColor(this.selectedQuality === 128 ? '#FF6B6B' : '#333333')
            .fontSize(14)
            .onClick(() => this.changeQuality(128))

          Divider().height(1).color($r('sys.color.ohos_id_color_list_separator'))

          Button('è¾ƒé«˜ 192K')
            .width('100%')
            .height(44)
            .backgroundColor(this.selectedQuality === 192 ? '#FFF0F0' : '#FFFFFF')
            .fontColor(this.selectedQuality === 192 ? '#FF6B6B' : '#333333')
            .fontSize(14)
            .onClick(() => this.changeQuality(192))

          Divider().height(1).color($r('sys.color.ohos_id_color_list_separator'))

          Button('é«˜å“ 320K')
            .width('100%')
            .height(44)
            .backgroundColor(this.selectedQuality === 320 ? '#FFF0F0' : '#FFFFFF')
            .fontColor(this.selectedQuality === 320 ? '#FF6B6B' : '#333333')
            .fontSize(14)
            .onClick(() => this.changeQuality(320))

          Divider().height(1).color($r('sys.color.ohos_id_color_list_separator'))

          Button('æ— æŸ FLAC')
            .width('100%')
            .height(44)
            .backgroundColor(this.selectedQuality === 999 ? '#FFF0F0' : '#FFFFFF')
            .fontColor(this.selectedQuality === 999 ? '#FF6B6B' : '#333333')
            .fontSize(14)
            .onClick(() => this.changeQuality(999))
        }
        .width('90%')
        .backgroundColor('#FFFFFF')
        .borderRadius(12)
        .shadow({ radius: 16, color: '#1F000000' })
        .position({ x: '5%', y: 70 })
        .zIndex(20)
      }

      Scroll() {
        Column() {
          // ğŸ”¥ ä¿®å¤ï¼šå°é¢å’Œæ­Œè¯åŒºåŸŸåˆ‡æ¢
          Stack() {
            // å°é¢å›¾ç‰‡åŒºåŸŸ
            if (!this.showLyrics) {
              Stack() {
                if (this.coverUrl) {
                  Image(this.coverUrl)
                    .width(280)
                    .height(280)
                    .borderRadius(140)
                    .backgroundColor($r('sys.color.ohos_id_color_background'))
                    .rotate({
                      x: 0,
                      y: 0,
                      z: 1,
                      angle: this.rotateAngle
                    })
                    .shadow({
                      radius: 20,
                      color: '#40000000',
                      offsetX: 0,
                      offsetY: 10
                    })
                } else {
                  Column() {
                    Text('ğŸµ')
                      .fontSize(80)
                      .opacity(0.3)
                  }
                  .width(280)
                  .height(280)
                  .borderRadius(140)
                  .backgroundColor($r('sys.color.ohos_id_color_background'))
                  .justifyContent(FlexAlign.Center)
                  .rotate({
                    x: 0,
                    y: 0,
                    z: 1,
                    angle: this.rotateAngle
                  })
                  .shadow({
                    radius: 20,
                    color: '#40000000',
                    offsetX: 0,
                    offsetY: 10
                  })
                }

                Column()
                  .width(50)
                  .height(50)
                  .borderRadius(25)
                  .backgroundColor('#FFFFFF')
                  .shadow({
                    radius: 5,
                    color: '#60000000',
                    offsetX: 0,
                    offsetY: 0
                  })
              }
              .width(280)
              .height(280)
            } else {
              // æ­Œè¯åŒºåŸŸ(æ›¿ä»£å°é¢ä½ç½®)
              Column() {
                if (this.lyrics.length > 0) {
                  List({ space: 12, scroller: this.scroller }) {
                    ForEach(this.lyrics, (lyric: LyricLine, index: number) => {
                      ListItem() {
                        LyricItem({
                          text: lyric.text,
                          isActive: this.currentLyricIndex === index
                        })
                      }
                    }, (lyric: LyricLine) => lyric.time.toString())
                  }
                  .width('100%')
                  .height('100%')
                  .scrollBar(BarState.Off)
                } else {
                  Column() {
                    Text('ğŸµ')
                      .fontSize(40)
                      .opacity(0.3)
                    Text('æš‚æ— æ­Œè¯')
                      .fontSize(14)
                      .fontColor($r('sys.color.ohos_id_color_text_secondary'))
                      .margin({ top: 12 })
                  }
                  .width('100%')
                  .height('100%')
                  .justifyContent(FlexAlign.Center)
                }
              }
              .width(280)
              .height(280)
              .backgroundColor('#F9F9F9')
              .borderRadius(12)
              .padding(16)
            }
          }
          .width(280)
          .height(280)
          .margin({ top: 40, bottom: 20 })

          // ğŸ”¥ åˆ‡æ¢æŒ‰é’®
          Button({ type: ButtonType.Normal }) {
            Row() {
              Text(this.showLyrics ? 'ğŸ“€ å°é¢' : 'ğŸ“ æ­Œè¯')
                .fontSize(14)
                .fontColor('#FF6B6B')
            }
          }
          .width(100)
          .height(36)
          .backgroundColor('#FFF0F0')
          .borderRadius(18)
          .margin({ bottom: 10 })
          .onClick(() => {
            this.showLyrics = !this.showLyrics;
          })

          Text(this.currentSong?.name || 'æœªçŸ¥æ­Œæ›²')
            .fontSize(22)
            .fontWeight(FontWeight.Bold)
            .maxLines(1)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
            .width('90%')
            .textAlign(TextAlign.Center)
            .margin({ bottom: 8 })

          Text(this.currentSong
            ? `${this.currentSong.artist} Â· ${this.currentSong.album || 'æœªçŸ¥ä¸“è¾‘'}`
            : 'æœªçŸ¥æ­Œæ‰‹')
            .fontSize(14)
            .fontColor($r('sys.color.ohos_id_color_text_secondary'))
            .maxLines(1)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
            .width('90%')
            .textAlign(TextAlign.Center)
            .margin({ bottom: 30 })

          Column() {
            Slider({
              value: this.currentTime,
              min: 0,
              max: this.duration || 100,
              step: 1,
              style: SliderStyle.OutSet
            })
              .blockColor('#FF6B6B')
              .trackColor('#EEEEEE')
              .selectedColor('#FF6B6B')
              .showSteps(false)
              .showTips(false)
              .onChange((value: number) => {
                this.onProgressChange(value);
              })

            Row() {
              Text(this.formatTime(this.currentTime))
                .fontSize(12)
                .fontColor($r('sys.color.ohos_id_color_text_secondary'))

              Text(this.formatTime(this.duration))
                .fontSize(12)
                .fontColor($r('sys.color.ohos_id_color_text_secondary'))
            }
            .width('100%')
            .justifyContent(FlexAlign.SpaceBetween)
            .margin({ top: 8 })
          }
          .width('90%')
          .margin({ bottom: 30 })

          Row() {
            Button({ type: ButtonType.Circle }) {
              Text('â®')
                .fontSize(24)
                .fontColor('#333333')
            }
            .width(50)
            .height(50)
            .backgroundColor('#F5F5F5')
            .enabled(this.currentIndex > 0)
            .opacity(this.currentIndex > 0 ? 1 : 0.5)
            .onClick(() => {
              this.previousSong();
            })

            Button({ type: ButtonType.Circle }) {
              Text(this.playState === PlayState.PLAYING ? 'â¸' : 'â–¶')
                .fontSize(32)
                .fontColor('#FFFFFF')
            }
            .width(70)
            .height(70)
            .backgroundColor('#FF6B6B')
            .margin({ left: 30, right: 30 })
            .onClick(() => {
              this.togglePlay();
            })

            Button({ type: ButtonType.Circle }) {
              Text('â­')
                .fontSize(24)
                .fontColor('#333333')
            }
            .width(50)
            .height(50)
            .backgroundColor('#F5F5F5')
            .enabled(this.currentIndex < this.playlist.length - 1)
            .opacity(this.currentIndex < this.playlist.length - 1 ? 1 : 0.5)
            .onClick(() => {
              this.nextSong();
            })
          }
          .margin({ bottom: 40 })

          // ğŸ”¥ æ­Œå•åˆ—è¡¨(å›ºå®šæ˜¾ç¤ºåœ¨åº•éƒ¨)
          Column() {
            Row() {
              Text('æ’­æ”¾åˆ—è¡¨')
                .fontSize(16)
                .fontWeight(FontWeight.Medium)

              Text(`${this.currentIndex + 1} / ${this.playlist.length}`)
                .fontSize(12)
                .fontColor($r('sys.color.ohos_id_color_text_secondary'))
                .margin({ left: 8 })
            }
            .width('100%')
            .justifyContent(FlexAlign.SpaceBetween)
            .margin({ bottom: 16 })

            List({ space: 8 }) {
              ForEach(this.playlist, (song: MusicItem, index: number) => {
                ListItem() {
                  Row() {
                    Text(`${index + 1}`)
                      .fontSize(14)
                      .fontColor('#999999')
                      .width(30)

                    Column() {
                      Text(song.name)
                        .fontSize(15)
                        .fontColor(index === this.currentIndex ? '#FF6B6B' : '#333333')
                        .fontWeight(index === this.currentIndex ? FontWeight.Bold : FontWeight.Normal)
                        .maxLines(1)
                        .textOverflow({ overflow: TextOverflow.Ellipsis })
                        .width('100%')

                      Text(song.artist)
                        .fontSize(12)
                        .fontColor('#999999')
                        .maxLines(1)
                        .textOverflow({ overflow: TextOverflow.Ellipsis })
                        .margin({ top: 4 })
                        .width('100%')
                    }
                    .layoutWeight(1)
                    .alignItems(HorizontalAlign.Start)
                    .margin({ left: 12 })

                    if (index === this.currentIndex) {
                      Text('â–¶')
                        .fontSize(16)
                        .fontColor('#FF6B6B')
                        .margin({ left: 8 })
                    }
                  }
                  .width('100%')
                  .padding({ top: 12, bottom: 12, left: 8, right: 8 })
                  .backgroundColor(index === this.currentIndex ? '#FFF5F5' : 'transparent')
                  .borderRadius(8)
                  .onClick(() => {
                    console.info('[PlayerPage] ç‚¹å‡»æ­Œå•é¡¹:', song.name, 'index:', index);
                    AudioPlayerService.getInstance().play(song, this.playlist, index)
                      .then(() => {
                        console.info('[PlayerPage] âœ… æ’­æ”¾æˆåŠŸ');
                      })
                      .catch((error: Error) => {
                        console.error('[PlayerPage] âŒ æ’­æ”¾å¤±è´¥:', error.message);
                        promptAction.showToast({ message: 'æ’­æ”¾å¤±è´¥' });
                      });
                  })
                }
              }, (song: MusicItem) => song.id.toString())
            }
            .width('100%')
            .height(300)
            .scrollBar(BarState.Auto)
          }
          .width('90%')
          .padding(20)
          .backgroundColor('#F9F9F9')
          .borderRadius(12)
          .margin({ bottom: 20 })
        }
        .width('100%')
      }
      .layoutWeight(1)
      .scrollBar(BarState.Off)
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#FFFFFF')
  }
}
